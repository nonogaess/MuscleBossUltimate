<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üí™ Muscle Boss Ultimate V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      min-height: 100vh;
      padding: 16px;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #e5e7eb;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px 12px 18px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(0, 255, 136, 0.2);
      border: 1px solid rgba(0, 255, 136, 0.1);
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.9rem;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
      color: #1a1833;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
      to { text-shadow: 0 0 30px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 255, 136, 0.5); }
    }
    header p {
      font-size: 0.85rem;
      color: #E8E8E8;
    }

    /* TOP TABS - 4 onglets comme sur le screenshot */
    .top-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 136, 0.2);
    }
    .top-tab-btn {
      flex: 1;
      padding: 10px 8px;
      border-radius: 999px;
      background: transparent;
      border: 2px solid transparent;
      color: #9ca3af;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .top-tab-btn:before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 999px;
      padding: 2px;
      background: linear-gradient(135deg, #1a1833, #E8E8E8);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .top-tab-btn.active {
      background: linear-gradient(135deg, #1a1833, #E8E8E8);
      color: #0f0c29;
      border-color: transparent;
      box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);
      transform: translateY(-1px);
    }
    .top-tab-btn:hover:not(.active) {
      color: #1a1833;
      border-color: rgba(0, 255, 136, 0.3);
    }
    .top-tab-btn:hover:not(.active):before {
      opacity: 1;
    }

    /* CONTENT SECTIONS - Transitions fluides */
    .content-section {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                  transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: none;
    }
    .content-section.active {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }
    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    label {
      font-size: 0.8rem;
      color: #E8E8E8;
      min-width: 80px;
      font-weight: 600;
    }
    select, input[type="date"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      background: rgba(0, 0, 0, 0.4);
      color: #e5e7eb;
      font-size: 0.83rem;
      outline: none;
      transition: all 0.3s ease;
    }
    select:focus, input:focus {
      border-color: #1a1833;
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
      background: rgba(0, 0, 0, 0.5);
    }

    .day-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }
    .day-btn {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      border: 2px solid rgba(0, 212, 255, 0.3);
      background: rgba(0, 0, 0, 0.3);
      color: #e5e7eb;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .day-btn.active {
      background: linear-gradient(135deg, #E8E8E8, #1a1833);
      color: #0f0c29;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(0, 212, 255, 0.4);
    }
    .day-btn:hover:not(.active) {
      background: rgba(0, 212, 255, 0.1);
      transform: translateY(-2px);
    }

    .section-title {
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: #E8E8E8;
      font-weight: 600;
    }

    .exercise-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid rgba(0, 255, 136, 0.3);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    .gif-wrapper {
      margin: 6px 0 8px;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 212, 255, 0.3);

      /* On limite la taille, mais on laisse l'image choisir sa hauteur */
      max-height: 220px;
    }

    /* L'image garde son ratio, et on ne la force plus en hauteur */
    .exercise-gif {
      display: block;
      width: 100%;
      height: auto;
      object-fit: contain;
      background: #020617;
    }
    .exercise-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(0, 255, 136, 0.3);
      border-color: #1a1833;
    }
    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .exercise-name {
      font-size: 0.96rem;
      font-weight: 600;
      color: #1a1833;
      cursor: pointer;
      transition: color 0.2s;
    }
    .exercise-name:hover {
      color: #E8E8E8;
    }
    .tag {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(0, 212, 255, 0.2);
      color: #E8E8E8;
      border: 1px solid rgba(0, 212, 255, 0.4);
    }

    .notes {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .notes span {
      display: block;
    }
    .notes strong {
      color: #e5e7eb;
    }

    .logs {
      margin-bottom: 8px;
    }
    .log-item {
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(15, 12, 41, 0.5));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 212, 255, 0.35);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
    .log-item:before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #1a1833, #E8E8E8);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .log-item:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 255, 136, 0.1));
      border-color: #1a1833;
      transform: translateX(4px);
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.25);
    }
    .log-item:hover:before {
      opacity: 1;
    }
    .log-empty {
      font-size: 0.75rem;
      color: #4b5563;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .delete-btn:hover {
      background: rgba(255, 107, 107, 0.2);
      transform: scale(1.1);
    }

    .log-form {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    .log-form-row {
      display: flex;
      gap: 4px;
    }
    .log-form-row input {
      flex: 1;
      min-width: 0;
      padding: 5px 8px;
      border-radius: 999px;
      border: 2px solid rgba(0, 255, 136, 0.3);
      background: rgba(0, 0, 0, 0.4);
      color: #fff;
      font-size: 0.75rem;
      outline: none;
      transition: all 0.3s ease;
    }
    .log-form-row input:focus {
      border-color: #1a1833;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    button.add-set {
      margin-top: 4px;
      padding: 7px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #1a1833, #E8E8E8);
      color: #0f0c29;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
    }
    button.add-set:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
    }

    .summary {
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 136, 0.3);
      font-size: 0.8rem;
    }
    .summary strong {
      color: #1a1833;
    }

    /* CANVAS */
    canvas {
      max-width: 100%;
      border-radius: 12px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px;
    }

    .radar-container {
      margin-top: 10px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .ipg-comparison-container {
      margin-top: 8px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
      height: 640px;          /* üëâ augmente ici si tu veux encore plus grand */
    }

    .exercise-detail-container {
      margin-top: 10px;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
      height: 400px;   /* augmente √† 380‚Äì400px si tu veux encore plus grand */
    }

    #exerciseChart {
      width: 100% !important;
      height: 100% !important;  /* üëà le canvas remplit la box */
      display: block;
    }

    .subtext {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 8px;
      line-height: 1.4;
    }

    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: rgba(15, 12, 41, 0.95);
      border: 2px solid #1a1833;
      border-radius: 20px;
      padding: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 255, 136, 0.3);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 1.3rem;
      color: #1a1833;
      font-weight: bold;
    }
    .modal-close {
      background: rgba(255, 107, 107, 0.2);
      border: 2px solid #ff6b6b;
      color: #ff6b6b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .modal-close:hover {
      background: rgba(255, 107, 107, 0.3);
      transform: rotate(90deg);
    }
    .modal-chart-container {
      position: relative;
      width: 100%;
      height: 500px;
    }

    .back-btn {
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      color: #E8E8E8;
      border: 2px solid rgba(0, 212, 255, 0.3);
      cursor: pointer;
      margin-bottom: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .back-btn:hover {
      background: rgba(0, 212, 255, 0.2);
      border-color: #E8E8E8;
      transform: translateX(-3px);
    }

    .exercise-stats {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 8px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }
    .exercise-stats div {
      margin-bottom: 4px;
    }
    .exercise-stats strong {
      color: #1a1833;
    }

    /* HISTORY SECTION */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .history-item {
      background: rgba(255, 255, 255, 0.05);
      border-left: 4px solid #1a1833;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .history-item:hover {
      background: rgba(0, 255, 136, 0.1);
      transform: translateX(5px);
    }
    .history-date {
      color: #E8E8E8;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .history-exercise {
      font-size: 0.85rem;
      color: #b0b0b0;
      margin-left: 10px;
    }

    .export-btn {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #1a1833, #E8E8E8);
      color: #0f0c29;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
      margin-top: 10px;
    }
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 255, 136, 0.5);
    }

    /* PROGRESSION SECTION */
    .progression-grid {
      display: grid;
      gap: 15px;
    }
    .progression-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px;
      border: 1px solid rgba(0, 255, 136, 0.3);
    }
    .progression-card h3 {
      color: #1a1833;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }
    .stat-label {
      color: #9ca3af;
    }
    .stat-value {
      color: #1a1833;
      font-weight: 600;
    }
    .stat-value.positive {
      color: #1a1833;
    }
    .stat-value.negative {
      color: #ff6b6b;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.5rem;
      }
      .top-tab-btn {
        font-size: 0.72rem;
        padding: 8px 4px;
      }
    }

        /* PR & SUGGESTIONS */
    .pr-flags {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #bbf7d0;
    }
    .pr-badge {
      display: inline-block;
      margin-right: 4px;
      margin-bottom: 2px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.5);
      color: #bbf7d0;
    }
    .suggestion {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #a5f3fc;
    }

    /* ====== FIFA PLAYER CARD - VERSION AUTHENTIQUE FIFA ====== */

    .fifa-wrapper {
      display: flex;
      gap: 14px;
      margin-bottom: 18px;
      align-items: stretch;
    }

    @media (max-width: 520px) {
      .fifa-wrapper {
        flex-direction: column;
      }
    }

    .fifa-card {
      flex: 1;
      position: relative;
      padding: 16px 14px 12px;
      
      /* Forme FIFA embl√©matique avec d√©coupe sup√©rieure et inf√©rieure */
      border-radius: 15% 15% 60% 60%;
      clip-path: polygon(
        0% 10%,
        10% 0%,
        90% 0%,
        100% 10%,
        100% 90%,
        90% 100%,
        10% 100%,
        0% 90%
      );
      
      /* Gradient dor√© FIFA exact */
      background: 
        radial-gradient(ellipse at top center, rgba(255, 255, 255, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, 
          #a2a2a0 0%,
          #a7a5a1 20%,
          #8a8983 40%,
          #7c7b75 60%,
          #686867 80%,
          #3d3b36 100%
        );
      
      box-shadow:
        0 20px 45px rgba(55, 54, 54, 0.8),
        0 8px 20px rgba(55, 54, 54, 0.5),
        inset 0 2px 8px rgba(255,255,255,0.4),
        inset 0 -2px 8px rgba(43, 42, 42, 0.2);
      
      border: none;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .fifa-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 
        0 25px 55px rgba(54, 52, 52, 0.9),
        0 12px 28px rgba(74, 72, 72, 0.6),
        0 0 50px rgba(244, 213, 130, 0.6),
        inset 0 2px 8px rgba(255, 255, 255, 0.5);
    }

    /* Rayons diagonaux depuis le coin sup√©rieur droit - effet FIFA iconique */
    .fifa-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 60%;
      background: 
        repeating-linear-gradient(
          135deg,
          transparent,
          transparent 8px,
          rgba(255, 255, 255, 0.12) 8px,
          rgba(255, 255, 255, 0.12) 10px,
          transparent 10px,
          transparent 18px,
          rgba(255, 255, 255, 0.08) 18px,
          rgba(255, 255, 255, 0.08) 20px
        );
      pointer-events: none;
      opacity: 0.8;
    }

    /* Texture subtile en damier diagonal */
    .fifa-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: 
        repeating-linear-gradient(
          -45deg,
          transparent,
          transparent 2px,
          rgba(0,0,0,0.02) 2px,
          rgba(0,0,0,0.02) 4px
        );
      pointer-events: none;
      opacity: 0.6;
    }

    .fifa-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2px;
      position: relative;
      z-index: 2;
    }

    /* Rating et position (en haut √† gauche) */
    .fifa-gen {
      text-align: center;
      position: relative;
    }

    .fifa-gen-label {
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 900;
      color: #fbfbfb;
      text-shadow: 
        0 1px 0 rgba(255, 255, 200, 0.6),
        0 0 3px rgba(0, 0, 0, 0.3);
    }

    .fifa-gen-value {
      font-size: 3.2rem;
      font-weight: 900;
      line-height: 0.75;
      margin-top: 2px;
      color: #f2f2f2;
      text-shadow: 
        1px 1px 0 rgba(255, 255, 200, 0.7),
        -1px -1px 0 rgba(0, 0, 0, 0.1),
        0 3px 5px rgba(0, 0, 0, 0.35);
      font-family: 'Impact', 'Arial Black', sans-serif;
    }

    .fifa-meta {
      font-size: 0.7rem;
      margin-top: 4px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #fefefe;
      text-shadow: 0 1px 0 rgba(255, 255, 200, 0.5);
    }

    /* Photo du joueur - grande et centr√©e */
    .fifa-photo {
      width: 100px;
      height: 100px;
      border-radius: 0;
      overflow: hidden;
      margin: 8px auto 4px;
      border: none;
      background: transparent;
      position: relative;
      z-index: 2;
    }

    .fifa-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center top;
    }

    .fifa-photo-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      background: rgba(255, 255, 255, 0.1);
    }

    /* Nom du joueur - sous la photo */
    .fifa-name {
      margin-top: 2px;
      margin-bottom: 6px;
      font-weight: 900;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.01em;
      color: #fffbfb;
      text-shadow: 
        0 1px 0 rgba(229, 229, 207, 0.6),
        0 2px 4px rgba(0, 0, 0, 0.25);
      text-align: center;
      font-family: 'Arial Black', sans-serif;
      position: relative;
      z-index: 2;
    }

    /* Stats FIFA - Format horizontal 6 colonnes comme sur l'image */
    .fifa-stats {
      margin-top: 0;
      padding-top: 8px;
      border-top: 2px solid rgb(238, 235, 231);
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* 6 colonnes PEC‚ÄìBIC */
      gap: 4px 2px;
      font-size: 0.7rem;
      position: relative;
      z-index: 2;
    }

    /* ABD & CAR centr√©s sous JAM / EPA */
    .fifa-stat-abd,
    .fifa-stat-car {
      grid-row: 2;          /* seconde ligne */
      margin-top: 4px;      /* l√©ger espace par rapport √† la ligne du dessus */
    }

    .fifa-stat-abd {
      grid-column: 3;       /* colonne de JAM */
    }

    .fifa-stat-car {
      grid-column: 4;       /* colonne de EPA */
    }

    .fifa-stat-line {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2px 1px;
      border-radius: 0;
      background: transparent;
      backdrop-filter: none;
    }

    .fifa-stat-label {
      font-weight: 900;
      text-transform: uppercase;
      font-size: 0.55rem;
      letter-spacing: 0.02em;
      color: #e8e6e4;
      text-shadow: 0 1px 0 rgba(255, 255, 200, 0.4);
      margin-bottom: 1px;
    }

    .fifa-stat-value {
      font-weight: 900;
      font-size: 1rem;
      color: #dbd9d6;
      text-shadow: 
        0 1px 0 rgba(255, 255, 200, 0.5),
        0 1px 3px rgba(0, 0, 0, 0.25);
      font-family: 'Arial Black', sans-serif;
    }

    /* Drapeaux et logos - en bas */
    .fifa-flags {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 1rem;
      margin-top: 6px;
      position: relative;
      z-index: 2;
    }

    .fifa-card-placeholder {
      font-size: 0.85rem;
      color: #3d2c0f;
      padding: 8px;
      text-align: center;
      font-weight: 700;
      text-shadow: 0 1px 0 rgba(255, 255, 200, 0.4);
    }

    /* R√©glages profil */
    .fifa-settings {
      width: 170px;
      background: rgba(15,23,42,0.85);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid rgba(0,255,136,0.3);
      font-size: 0.8rem;
    }

    .fifa-settings-title {
      font-weight: 600;
      color: #1a1833;
      margin-bottom: 6px;
    }

    .fifa-label {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-bottom: 6px;
      font-size: 0.75rem;
      color: #e5e7eb;
    }

    .fifa-label input {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.75rem;
    }

    .fifa-label input[type="file"] {
      padding: 3px;
    }

    .fifa-details-btn {
      margin-top: 4px;
      width: 100%;
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#1a1833,#E8E8E8);
      color: #0f0c29;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* Panneau de d√©tails */
    .fifa-details {
      display: none;
      margin-bottom: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.16), transparent 55%),
                  rgba(15,23,42,0.97);
      border: 1px solid rgba(56,189,248,0.35);
      font-size: 0.8rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
    }

    .fifa-details.open {
      display: block;
    }

    .fifa-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .fifa-details-header button {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.7rem;
      background: rgba(239,68,68,0.15);
      color: #fecaca;
      cursor: pointer;
    }

    .fifa-details-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .fifa-section-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #a5b4fc;
      margin: 4px 0 2px;
    }

    /* Ligne avec barre de progression */
    .fifa-bar-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 3fr) auto;
      align-items: center;
      gap: 6px;
    }

    .fifa-bar-label {
      color: #e5e7eb;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .fifa-bar-track {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.9);
      overflow: hidden;
    }

    .fifa-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
    }

    .fifa-bar-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #f9fafb;
      font-size: 0.8rem;
    }

    /* BADGES - Style am√©lior√© */
    .badge-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.05));
      border: 1px solid rgba(0, 255, 136, 0.3);
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .badge-item:hover {
      transform: translateX(5px);
      border-color: #1a1833;
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 212, 255, 0.1));
      box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3);
    }
    .badge-icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      animation: badge-pulse 2s ease-in-out infinite;
    }
    @keyframes badge-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .badge-content {
      flex: 1;
    }
    .badge-label {
      font-weight: 700;
      font-size: 0.9rem;
      color: #1a1833;
      margin-bottom: 2px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }
    .badge-desc {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.3;
    }
    #badgesContainer {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(15, 12, 41, 0.5)) !important;
      border: 1px solid rgba(0, 255, 136, 0.3) !important;
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    /* =========================================================
        THEME UNIFIE MUSCLE BOSS
        Fond #babbbf ‚Äì Accent #1a1833 ‚Äì Texte #E8E8E8 ‚Äì Cartes #1a1833
        (La carte FIFA garde son propre style dor√©)
        ========================================================= */

      :root {
        --mb-bg-main: #0f172a;
        --mb-accent: #1a1833;
        --mb-text: #E8E8E8;
        --mb-text-muted: #9CA3AF;
        --mb-card: #1a1833;
        --mb-danger: #FF6B6B;
      }

      /* Fond global et container principal */

      body {
        min-height: 100vh;
        padding: 16px;
        background: var(--mb-bg-main);
        color: var(--mb-text);
      }

      .app {
        max-width: 520px;
        margin: 0 auto;
        padding: 16px 12px 18px;
        border-radius: 24px;
        background: transparent;          /* on laisse le fond global respirer */
        box-shadow: none;
        border: none;
      }

      /* Header */

      header {
        text-align: left;
        margin-bottom: 16px;
      }

      header h1 {
        font-size: 1.9rem;
        letter-spacing: 0.04em;
        margin-bottom: 4px;
        color: #b7b7b7;
        text-shadow: none;
        animation: none;
      }

      header p {
        font-size: 0.9rem;
        color: var(--mb-text-muted);
      }

      /* Onglets du haut */

      .top-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 4px;
        border-radius: 999px;
        background: var(--mb-card);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .top-tab-btn {
        flex: 1;
        padding: 10px 8px;
        border-radius: 999px;
        background: transparent;
        border: 1px solid transparent;
        color: var(--mb-text-muted);
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .top-tab-btn.active {
        background: var(--mb-accent);
        color: #babbbf;
        border-color: transparent;
        box-shadow: 0 8px 20px rgba(27, 201, 199, 0.35);
        transform: translateY(-1px);
      }

      .top-tab-btn:hover:not(.active) {
        color: var(--mb-accent);
        border-color: rgba(27, 201, 199, 0.4);
      }

      /* Sections & titres */

      .section-title {
        font-size: 0.9rem;
        margin-bottom: 6px;
        color: #b7b7b7;
        font-weight: 600;
      }

      .subtext {
        font-size: 0.75rem;
        color: var(--mb-text-muted);
      }

      /* Cartes / encadr√©s g√©n√©raux */

      .controls,
      .exercise-card,
      .summary,
      .radar-container,
      .ipg-comparison-container,
      .exercise-detail-container,
      #badgesContainer,
      .history-item,
      .progression-card,
      .modal-content,
      .fifa-settings,
      .fifa-details {
        background: var(--mb-card) !important;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.06) !important;
        backdrop-filter: none;
        box-shadow: none;
      }

      /* Inputs & selects */

      label {
        font-size: 0.8rem;
        color: var(--mb-text-muted);
        font-weight: 600;
      }

      select,
      input[type="date"],
      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: #111827;
        color: var(--mb-text);
        font-size: 0.83rem;
        outline: none;
        transition: all 0.25s ease;
      }

      select:focus,
      input:focus {
        border-color: var(--mb-accent);
        box-shadow: 0 0 0 1px rgba(27, 201, 199, 0.6);
        background: #020617;
      }

      /* Boutons ‚ÄúS√©ance A/B/C‚Äù */

      .day-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
      }

      .day-btn {
        flex: 1;
        padding: 8px 0;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: #111827;
        color: var(--mb-text);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
      }

      .day-btn.active {
        background: var(--mb-accent);
        color: #babbbf;
        border-color: transparent;
        box-shadow: 0 6px 16px rgba(27, 201, 199, 0.4);
      }

      .day-btn:hover:not(.active)) {
        background: #1F2937;
      }

      /* Cartes d‚Äôexercices & logs */

      .exercise-name {
        font-size: 0.96rem;
        font-weight: 600;
        color: var(--mb-text);
      }

      .tag {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(27, 201, 199, 0.14);
        color: #b7b7b7;
        border: 1px solid rgba(27, 201, 199, 0.6);
      }

      .notes {
        font-size: 0.75rem;
        color: var(--mb-text-muted);
      }

      .log-item {
        font-size: 0.8rem;
        padding: 8px 10px;
        border-radius: 14px;
        background: #111827;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: none;
      }

      .log-item:hover {
        background: #1F2937;
        border-color: var(--mb-accent);
        transform: translateX(3px);
      }

      .log-empty {
        font-size: 0.75rem;
        color: var(--mb-text-muted);
      }

      /* Bouton supprimer */

      .delete-btn {
        background: none;
        border: none;
        color: var(--mb-danger);
        cursor: pointer;
        font-size: 0.9rem;
        padding: 2px 6px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .delete-btn:hover {
        background: rgba(255, 107, 107, 0.12);
      }

      /* Boutons principaux */

      button.add-set,
      .export-btn,
      #importBtn,
      .fifa-details-btn,
      .back-btn {
        border-radius: 999px;
        border: none;
        background: var(--mb-accent);
        color: #babbbf;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 6px 18px rgba(27, 201, 199, 0.35);
      }

      button.add-set:hover,
      .export-btn:hover,
      #importBtn:hover,
      .fifa-details-btn:hover,
      .back-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 22px rgba(27, 201, 199, 0.55);
      }

      /* R√©sum√©s / badges / stats */

      .summary strong,
      .progression-card h3,
      .stat-value {
        color: #b7b7b7;
      }

      .stat-label {
        color: var(--mb-text-muted);
      }

      .history-date {
        color: #b7b7b7;
      }

      /* Modal */

      .modal-overlay {
        background: rgba(0, 0, 0, 0.75);
      }

      .modal-title {
        color: var(--mb-accent);
      }

      /* Canvas fond neutre */

      canvas {
        max-width: 100%;
        border-radius: 12px;
        background: #020617;
        padding: 10px;
      }

  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üí™ MUSCLE BOSS ULTIMATE</h1>
      <p>Suivi Pro ¬∑ Programme A/B/C ¬∑ Arnaud & Dancho</p>
    </header>

    <!-- TOP TABS - 4 onglets -->
    <div class="top-tabs">
      <button class="top-tab-btn active" data-tab="home">Accueil</button>
      <button class="top-tab-btn" data-tab="entrainement">Entra√Ænement</button>
      <button class="top-tab-btn" data-tab="statistiques">Statistiques</button>
      <button class="top-tab-btn" data-tab="historique">Historique</button>
      <button class="top-tab-btn" data-tab="progression">Progression</button>
    </div>

    <!-- SECTION ACCUEIL / DASHBOARD -->
    <div class="content-section active" id="home">
      <h2 class="section-title">üè† Carte joueur & tableau de bord</h2>

      <!-- Wrapper FIFA CARD + param√®tres -->
      <div class="fifa-wrapper">
        <!-- Carte fa√ßon FIFA -->
        <div class="fifa-card" id="fifaCard">
          <!-- Le contenu sera g√©n√©r√© en JS -->
          <div class="fifa-card-placeholder">
            Commence √† enregistrer des s√©ances pour g√©n√©rer ta carte joueur ‚öΩüí™
          </div>
        </div>

        <!-- R√©glages du profil -->
        <div class="fifa-settings">
          <div class="fifa-settings-title">Profil joueur</div>

          <label class="fifa-label">
            Nom sur la carte
            <input type="text" id="profileNameInput" placeholder="Arnaud" />
          </label>

          <label class="fifa-label">
            Nationalit√© (emoji ou texte)
            <input type="text" id="profileFlagInput" placeholder="üá´üá∑ France" />
          </label>

          <label class="fifa-label">
            Club / Salle
            <input type="text" id="profileClubInput" placeholder="MuscleBoss Gym" />
          </label>

          <label class="fifa-label">
            Photo de profil
            <input type="file" id="profilePhotoInput" accept="image/*" />
          </label>

          <div class="subtext" style="margin-top:4px;">
            Utilisateur actuel : <strong id="homeCurrentUser">Arnaud</strong>
          </div>

          <button class="fifa-details-btn" id="fifaDetailsBtn">
            Voir les d√©tails par muscle
          </button>
        </div>
      </div>

      <!-- D√©tails des stats (verso de la carte) -->
      <div class="fifa-details" id="fifaDetailsPanel">
        <div class="fifa-details-header">
          <span>D√©tails des notes (30 derniers jours)</span>
          <button id="fifaDetailsClose">Fermer</button>
        </div>
        <div class="fifa-details-grid" id="fifaDetailsGrid">
          <!-- rempli en JS -->
        </div>
      </div>

      <!-- Cartes du dashboard classique -->
      <h3 class="section-title" style="margin-top:10px;">üìä R√©sum√© des s√©ances</h3>
      <div class="progression-grid" id="homeGrid"></div>
    </div>

    <!-- SECTION ENTRA√éNEMENT -->
    <div class="content-section" id="entrainement">
      <div class="controls">
        <div class="control-row">
          <label>Utilisateur</label>
          <select id="userSelect">
            <option value="Arnaud">Arnaud</option>
            <option value="Dancho">Dancho</option>
          </select>
        </div>
        <div class="control-row">
          <label>Date</label>
          <input type="date" id="dateInput" />
        </div>
         <div class="control-row">
          <label>Fatigue du jour</label>
          <select id="fatigueSelect">
            <option value="fresh">Frais</option>
            <option value="normal" selected>Normal</option>
            <option value="tired">Fatigu√©</option>
            <option value="wrecked">Rinc√©</option>
          </select>
        </div>
      </div>

      <div class="day-tabs">
        <button class="day-btn active" data-day="A">S√©ance A</button>
        <button class="day-btn" data-day="B">S√©ance B</button>
        <button class="day-btn" data-day="C">S√©ance C</button>
      </div>

      <div id="exercisesContainer"></div>
      <div class="summary" id="summaryEl"></div>
    </div>

    <!-- SECTION STATISTIQUES -->
    <div class="content-section" id="statistiques">
      <h2 class="section-title">üìà Performance globale (30 derniers jours)</h2>
      <div class="radar-container">
        <canvas id="radarChart"></canvas>
      </div>
      <div id="dashInfo" class="subtext"></div>
      <div id="ipgSummary" class="summary" style="margin-top:8px;"></div>
      <div id="badgesContainer" class="summary" style="margin-top:8px;"></div>
    </div>

    <!-- SECTION HISTORIQUE -->
    <div class="content-section" id="historique">
      <h2 class="section-title">üìÖ Historique des Entra√Ænements</h2>
      <div class="history-list" id="historyList"></div>
      <button class="export-btn" id="exportBtn">üíæ Exporter les donn√©es</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
      <button class="export-btn" id="importBtn">üìÇ Importer des donn√©es</button>
    </div>

    <!-- SECTION PROGRESSION -->
    <div class="content-section" id="progression">
      <h2 class="section-title">üéØ Analyse de Progression</h2>

      <!-- Cartes r√©cap Arnaud / Dancho -->
      <div class="progression-grid" id="progressionGrid"></div>

       <!-- Comparatif IPG par s√©ance -->
      <h3 class="section-subtitle" style="margin-top:16px;">√âvolution de l'IPG par s√©ance ‚Äî Arnaud vs Dancho</h3>
      <div class="ipg-comparison-container">
        <canvas id="ipgComparisonChart"></canvas>
      </div>
      <div id="ipgComparisonInfo" class="subtext"></div>
    </div>

    <!-- SECTION D√âTAIL EXERCICE -->
    <div class="content-section" id="exerciseDetail">
      <button class="back-btn" id="backBtn">‚Üê Retour</button>
      <h2 id="exerciseDetailTitle" style="color:#1a1833; margin-bottom:10px;"></h2>
      <div class="exercise-detail-container">
        <canvas id="exerciseChart"></canvas>
      </div>
      <div class="exercise-stats" id="exerciseStats"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Graphique</h3>
        <button class="modal-close" id="modalClose">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-chart-container">
          <canvas id="modalChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== PROGRAM DATA (from your file) ==========
    const program = {
  A: {
    name: "Lundi ‚Äî Pecs / Triceps / √âpaules",
    exercises: [

      {
        id: "chest_press",
        name: "Chest Press Convergente",
        muscle: "Pecs",
        refMax: 100,
        gifUrl: "chest_press.gif",
        notesArnaud: "4√ó8‚Äì10 ‚Ä¢ RPE 7.5‚Äì9 ‚Ä¢ Repos 90s ‚Ä¢ Charge progressive ‚Ä¢ Pas √† l‚Äô√©chec syst√©matique.",
        notesDancho: "4√ó8‚Äì10 ‚Ä¢ Superset pompes ‚Ä¢ Tempo rapide ‚Ä¢ Repos 45‚Äì60s ‚Ä¢ Pompes non √† l‚Äô√©chec.",
        recommendedMode: "total"
      },

      {
        id: "db_incline_press",
        name: "D√©velopp√© inclin√© halt√®res (20‚Äì30¬∞)",
        muscle: "Pecs",
        refMax: 60,
        gifUrl: "db_press_neutral.gif",
        notesArnaud: "4√ó10‚Äì12 ‚Ä¢ Inclinaison max 30¬∞ ‚Ä¢ RPE ‚â§9 ‚Ä¢ Contr√¥le total ‚Ä¢ Repos 90s.",
        notesDancho: "4√ó10‚Äì12 ‚Ä¢ Tempo lent 3‚Äì1‚Äì2 ‚Ä¢ Charge mod√©r√©e ‚Ä¢ Focus sensation pecs.",
        recommendedMode: "per_arm"
      },

      {
        id: "cable_fly_any",
        name: "√âcart√©s poulie / Pec Deck",
        muscle: "Pecs",
        refMax: 40,
        gifUrl: "cable_fly_any.gif",
        notesArnaud: "3√ó12‚Äì15 ‚Ä¢ Repos complet ‚Ä¢ √âtirement contr√¥l√© ‚Ä¢ Aucun balancement.",
        notesDancho: "3√ó12‚Äì15 ‚Ä¢ Superset dips ‚Ä¢ Amplitude partielle ‚Ä¢ Pas de dips profonds si g√™ne √©paules.",
        recommendedMode: "total"
      },

      {
        id: "triceps_choice",
        name: "Dips",
        muscle: "Triceps",
        refMax: 60,
        gifUrl: "dips.gif",
        notesArnaud: "3√ó10‚Äì12 ‚Ä¢ Focus triceps ‚Ä¢ Extension poulie recommand√©e si coudes sensibles.",
        notesDancho: "3√ó10‚Äì12 ‚Ä¢ Superset extension triceps ‚Ä¢ Rythme soutenu.",
        recommendedMode: "bodyweight"
      },

      {
        id: "lat_raise",
        name: "√âl√©vations lat√©rales",
        muscle: "√âpaules",
        refMax: 20,
        gifUrl: "lat_raise.gif",
        notesArnaud: "3√ó15 ‚Ä¢ Strict ‚Ä¢ RPE 8‚Äì9 ‚Ä¢ Charge progressive.",
        notesDancho: "3√ó15 ‚Ä¢ Superset gainage 1 min ‚Ä¢ Pas d‚Äô√©lan.",
        recommendedMode: "per_arm"
      },

      {
        id: "triceps_overhead",
        name: "Extension triceps overhead √† la poulie",
        muscle: "Triceps",
        refMax: 40,
        gifUrl: "triceps_overhead.gif",
        notesArnaud: "3√ó12‚Äì15 ‚Ä¢ RPE 8‚Äì9 ‚Ä¢ √âtirement contr√¥l√© ‚Ä¢ Pas d‚Äô√©chec ‚Ä¢ Repos 45‚Äì60s.",
        notesDancho: "3√ó12‚Äì15 ‚Ä¢ Finisher bras ‚Ä¢ Br√ªlure recherch√©e ‚Ä¢ Tempo continu.",
        recommendedMode: "per_arm"
      }
    ]
  },

  B: {
    name: "Mercredi ‚Äî Dos / Biceps / Abdos",
    exercises: [

      {
        id: "lat_pulldown",
        name: "Tractions OU Tirage Vertical",
        muscle: "Dos",
        refMax: 100,
        gifUrl: "lat_pulldown.gif",
        notesArnaud: "4√ó8‚Äì10 ‚Ä¢ Tirage machine prioritaire ‚Ä¢ Tractions lest√©es seulement si fra√Æcheur ++ ‚Ä¢ Repos 90‚Äì120s.",
        notesDancho: "4√ó8‚Äì10 ‚Ä¢ Superset rowing TRX ‚Ä¢ Tempo contr√¥l√© ‚Ä¢ Repos 60s.",
        recommendedMode: "total"
      },

      {
        id: "row_machine",
        name: "Rowing (machine ou halt√®res appuy√©s)",
        muscle: "Dos",
        refMax: 100,
        gifUrl: "row_machine.gif",
        notesArnaud: "4√ó10‚Äì12 ‚Ä¢ Machine ou halt√®res appuy√©s ‚Ä¢ √âviter rowing barre lourd ‚Ä¢ RPE ‚â§9.",
        notesDancho: "4√ó10‚Äì12 ‚Ä¢ Tempo lent ‚Ä¢ Contraction maximale ‚Ä¢ Superset possible.",
        recommendedMode: "per_arm"
      },

      {
        id: "low_row",
        name: "Tirage horizontal poulie",
        muscle: "Dos",
        refMax: 100,
        gifUrl: "low_row.gif",
        notesArnaud: "3√ó12‚Äì15 ‚Ä¢ Repos complet ‚Ä¢ Trajectoire propre.",
        notesDancho: "3√ó12‚Äì15 ‚Ä¢ Superset curl biceps ‚Ä¢ Repos 45‚Äì60s.",
        recommendedMode: "total"
      },

      {
        id: "incline_curl",
        name: "Curl barre ou halt√®res",
        muscle: "Biceps",
        refMax: 30,
        gifUrl: "incline_curl.gif",
        notesArnaud: "3√ó10‚Äì12 ‚Ä¢ Charges mod√©r√©es ‚Ä¢ Aucun balancement.",
        notesDancho: "3√ó10‚Äì12 ‚Ä¢ Superset crunchs ‚Ä¢ Rythme √©lev√©.",
        recommendedMode: "per_arm"
      },

      {
        id: "core_combo",
        name: "Crunchs + Gainage",
        muscle: "Abdos",
        refMax: null,
        gifUrl: "abs.gif",
        notesArnaud: "3 s√©ries ‚Ä¢ 20 crunchs + gainage long ‚Ä¢ Focus stabilit√©.",
        notesDancho: "3 s√©ries ‚Ä¢ Gainage lest√© ou instable ‚Ä¢ Intensit√© max.",
        recommendedMode: "virtual"
      },

      {
        id: "spider_curl",
        name: "Curl pupitre / Spider curl",
        muscle: "Biceps",
        refMax: 30,
        gifUrl: "spider_curl.gif",
        notesArnaud: "3√ó10‚Äì12 ‚Ä¢ Strict ‚Ä¢ Aucun √©lan ‚Ä¢ RPE 8‚Äì9 ‚Ä¢ Repos 45‚Äì60s.",
        notesDancho: "3√ó10‚Äì12 ‚Ä¢ Dernier set drop-set possible ‚Ä¢ Contraction maximale.",
        recommendedMode: "per_arm"
      }
    ]
  },

  C: {
    name: "Vendredi ‚Äî Jambes / Full Body / Cardio",
    exercises: [

      {
        id: "hack",
        name: "Hack Squat",
        muscle: "Quadriceps",
        refMax: 140,
        gifUrl: "hack.gif",
        notesArnaud: "4√ó8‚Äì10 ‚Ä¢ Lourd ‚Ä¢ Repos 90s ‚Ä¢ Mouvement phare ‚Ä¢ Posture stable.",
        notesDancho: "4√ó8‚Äì10 ‚Ä¢ Superset fentes statiques ‚Ä¢ Charge mod√©r√©e ‚Ä¢ Volume √©lev√©.",
        recommendedMode: "total"
      },

      {
        id: "leg_press",
        name: "Presse √† cuisses",
        muscle: "Quadriceps",
        refMax: 350,
        gifUrl: "leg_press.gif",
        notesArnaud: "4√ó10‚Äì12 ‚Ä¢ Charges progressives ‚Ä¢ Repos 120s.",
        notesDancho: "4√ó10‚Äì12 ‚Ä¢ Superset mollets ‚Ä¢ Attention fatigue quadriceps.",
        recommendedMode: "total"
      },

      {
        id: "rdl",
        name: "Soulev√© de terre jambes tendues",
        muscle: "Ischios",
        refMax: 100,
        gifUrl: "rdl.gif",
        notesArnaud: "3√ó12 ‚Ä¢ RPE ‚â§8.5 ‚Ä¢ Repos complet ‚Ä¢ Jamais √† l‚Äô√©chec.",
        notesDancho: "3√ó12 ‚Ä¢ Tempo lent ‚Ä¢ Stretch contr√¥l√©.",
        recommendedMode: "total"
      },

      {
        id: "walking_lunges",
        name: "Fentes march√©es",
        muscle: "Jambes",
        refMax: 60,
        gifUrl: "bulgarian_split.gif",
        notesArnaud: "3√ó12 / jambe ‚Ä¢ Charges mod√©r√©es ‚Ä¢ Contr√¥le.",
        notesDancho: "3√ó12 / jambe ‚Ä¢ Superset gainage dynamique ‚Ä¢ Rythme √©lev√©.",
        recommendedMode: "per_arm"
      },

      {
        id: "hiit",
        name: "Cardio HIIT 30s / 30s",
        muscle: "Cardio",
        refMax: null,
        gifUrl: null,
        notesArnaud: "15 min ‚Ä¢ Intensit√© mod√©r√©e ‚Ä¢ √Ä √©viter si jambes d√©j√† vides.",
        notesDancho: "15 min ‚Ä¢ Intensit√© maximale üî•",
        recommendedMode: "bodyweight"
      },

      {
        id: "hammer_curl_cable",
        name: "Curl marteau √† la poulie",
        muscle: "Biceps",
        refMax: 35,
        gifUrl: "hammer_curl.gif",
        notesArnaud: "3√ó12‚Äì15 ‚Ä¢ RPE 7‚Äì8 ‚Ä¢ Optionnel si fatigue haute ‚Ä¢ Repos 30‚Äì45s.",
        notesDancho: "3√ó12‚Äì15 ‚Ä¢ Pompe maximale ‚Ä¢ Encha√Ænable avant cardio.",
        recommendedMode: "per_arm"
      }
    ]
  }
};

    // R√©f√©rentiels de performance "haut niveau" par muscle (1RM ou √©quivalent)
    const musclePerformanceRef = {
      "Pecs": 140,
      "Dos": 160,
      "Quadriceps": 220,
      "Ischios": 140,
      "√âpaules": 70,
      "Biceps": 50,
      "Triceps": 70,
      "Abdos": 0,    // √† traiter √† part
      "Cardio": 0    // √† traiter √† part
    };

    // Mapping exercice ‚Üí muscle (utilis√© partout, pas seulement dans les stats)
    const exerciseToMuscle = {
      chest_press: "Pecs",
      db_incline_press: "Pecs",
      cable_fly_any: "Pecs",
      triceps_choice: "Triceps",
      triceps_overhead: "Triceps",
      lat_raise: "√âpaules",

      lat_pulldown: "Dos",
      row_machine: "Dos",
      low_row: "Dos",

      incline_curl: "Biceps",
      spider_curl: "Biceps",
      hammer_curl_cable: "Biceps",

      core_combo: "Abdos",

      hack: "Quadriceps",
      leg_press: "Quadriceps",
      rdl: "Ischios",
      walking_lunges: "Quadriceps",

      hiit: "Cardio"
    };

    // ========== STATE ==========
    const state = {
      user: "Arnaud",
      date: new Date().toISOString().split("T")[0],
      currentDay: "A",
      fatigue: "normal",
      logs: []
    };

    let currentView = "home";
    let currentExerciseId = null;
    let radarChart = null;
    let exerciseChart = null;
    let modalChart = null;
    let ipgComparisonChart = null;

    // ====== PROFIL JOUEUR / CARTE FIFA ======
    let playerProfile = {
      name: "Arnaud",
      flag: "üá´üá∑ France",
      club: "MuscleBoss Gym",
      photoDataUrl: null
    };

    function loadPlayerProfile() {
      const raw = localStorage.getItem("musclePlayerProfile");
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          playerProfile = { ...playerProfile, ...parsed };
        } catch (e) {
          console.warn("Profil joueur invalide, on repart sur le d√©faut.");
        }
      }
    }

    function savePlayerProfile() {
      localStorage.setItem("musclePlayerProfile", JSON.stringify(playerProfile));
    }

    // ========== HELPERS ==========
    function loadState() {
      const saved = localStorage.getItem("muscleAppState");
      if (saved) {
        const parsed = JSON.parse(saved);
        state.logs = parsed.logs || [];
        state.user = parsed.user || state.user;
        state.date = parsed.date || state.date;
        state.fatigue = parsed.fatigue || state.fatigue;
        state.currentDay = parsed.currentDay || state.currentDay;
      }
    }

    function saveState() {
      localStorage.setItem(
        "muscleAppState",
        JSON.stringify({
          logs: state.logs,
          user: state.user,
          date: state.date,
          fatigue: state.fatigue,
          currentDay: state.currentDay
        })
      );
    }

    function estimate1RM(weight, reps) {
      if (weight <= 0 || reps <= 0) return 0;
      return weight * (1 + reps / 30);
    }

        // Poids "effectif" utilis√© dans tous les calculs (volume, 1RM, etc.)
        function getEffectiveWeight(log) {
          const raw = Number(log.weight) || 0;
          const mode = log.mode || "total"; // fallback : total

          if (mode === "per_arm") {
            // Exemple : 20 kg par bras ‚Üí 40 kg de volume total
            return raw * 2;
          } else if (mode === "virtual") {
            // Abdos / mouvements sans leste : si 0 ‚Üí on applique 5 kg par d√©faut
            return raw > 0 ? raw : 5;
          } else if (mode === "bodyweight") {
            // Poids du corps (dips, pompes, etc.)
            // On consid√®re qu'environ 40% du poids corporel agit comme charge "force" sur le muscle cible.
            // - Si tu entres ton poids (ex: 80 kg) ‚Üí 0.4 √ó 80 = 32 kg
            // - Si tu laisses vide (anciens logs) ‚Üí on garde un petit 10 kg symbolique
            if (raw <= 0) return 10;
            return raw * 0.4;
          } else {
            // "total" (barre, machine, poulie √† deux mains, etc.)
            return raw;
          }
        }

        // 1RM bas√© sur un log complet (en tenant compte du mode)
        function estimateLog1RM(log) {
          const w = getEffectiveWeightFor1RM(log);
          const r = Number(log.reps) || 0;
          return estimate1RM(w, r);
        }

    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    function buildFifaBarRow(label, value) {
      const safeValue = isNaN(value) ? 0 : value;
      const width = clamp(safeValue, 0, 100);

      return `
        <div class="fifa-bar-row">
          <div class="fifa-bar-label">${label}</div>
          <div class="fifa-bar-track">
            <div class="fifa-bar-fill" style="width:${width}%;"></div>
          </div>
          <div class="fifa-bar-value">${safeValue}</div>
        </div>
      `;
    }

    // ========== GESTION DES MODES DE CHARGE ==========
    // Retourne le mode de log ("total", "per_arm", "bodyweight", "virtual")
    // avec un fallback propre pour les anciens logs.
    function getLogMode(log) {
      if (log.mode) return log.mode;

      // Si pas de mode dans le log (ancienne version),
      // on essaie de tomber sur le recommendedMode de l'exercice, sinon "total".
      let recommended = null;
      Object.values(program).forEach(day => {
        day.exercises.forEach(ex => {
          if (ex.id === log.exerciseId && ex.recommendedMode) {
            recommended = ex.recommendedMode;
          }
        });
      });

      return recommended || "total";
    }

    // Poids effectif pour tout ce qui est "volume" (tonnage, IPG, etc.)
    function getEffectiveWeightForVolume(log) {
      const w = Number(log.weight) || 0;
      const mode = getLogMode(log);

      if (mode === "per_arm") {
        // 20 kg par bras => 40 kg de tonnage
        return w * 2;
      }

      if (mode === "bodyweight" || mode === "virtual") {
        // Pour l'instant, on ne compte pas de tonnage pour le poids du corps / abdos.
        // On pourra plus tard brancher une "charge virtuelle" (ex : 0.25 √ó poids du corps).
        return 0;
      }

      // "total" et fallback
      return w;
    }

    // Poids effectif pour les calculs de 1RM (force "par bras" si tu as logg√© par bras)
    function getEffectiveWeightFor1RM(log) {
      const w = Number(log.weight) || 0;
      const mode = getLogMode(log);

      if (mode === "bodyweight") {
        // M√™me logique que pour getEffectiveWeight : on ne compte pas 100% du poids du corps
        if (w <= 0) return 0;
        return w * 0.4;
      }

      // Pour le reste (per_arm, total, virtual), on garde la logique actuelle :
      // 1RM = "poids saisi" interpr√©t√© comme charge principale.
      return w;
    }

    // ========== DOM ELEMENTS ==========
    const userSelect = document.getElementById("userSelect");
    const dateInput = document.getElementById("dateInput");
    const dayButtons = document.querySelectorAll(".day-btn");
    const tabButtons = document.querySelectorAll(".top-tab-btn");
    const exercisesContainer = document.getElementById("exercisesContainer");
    const summaryEl = document.getElementById("summaryEl");
    const radarChartCanvas = document.getElementById("radarChart");
    const dashInfo = document.getElementById("dashInfo");
    const historyList = document.getElementById("historyList");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFileInput = document.getElementById("importFile");
    const progressionGrid = document.getElementById("progressionGrid");
    const homeGrid = document.getElementById("homeGrid");
    const homeCurrentUser = document.getElementById("homeCurrentUser");
    const fifaDetailsPanel = document.getElementById("fifaDetailsPanel");
    const backBtn = document.getElementById("backBtn");
    const exerciseDetailTitle = document.getElementById("exerciseDetailTitle");
    const exerciseStats = document.getElementById("exerciseStats");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalClose = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const fatigueSelect = document.getElementById("fatigueSelect");

    // ========== TAB SWITCHING ==========
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const targetTab = btn.dataset.tab;
        
        // Update active button
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        
        // Update active section with transition
        document.querySelectorAll(".content-section").forEach(section => {
          section.classList.remove("active");
        });
        
        setTimeout(() => {
          document.getElementById(targetTab).classList.add("active");
          currentView = targetTab;
          
          // Render content for specific tabs
          if (targetTab === "statistiques") {
            renderStatistics();
          } else if (targetTab === "historique") {
            renderHistory();
          } else if (targetTab === "progression") {
            renderProgression();
          } else if (targetTab === "home") {
            renderHome();
          }
        }, 100);
      });
    });

    // ========== EVENT LISTENERS ==========
    userSelect.addEventListener("change", (e) => {
      state.user = e.target.value;
      saveState();
      renderEntrainement();
      renderStatistics();
      renderProgression();
      renderHome();
      updateTheme();
    });

    dateInput.addEventListener("change", (e) => {
      state.date = e.target.value;
      saveState();
      renderEntrainement();
      renderHome();
    });

    dayButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        dayButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        state.currentDay = btn.dataset.day;
        saveState();
        renderEntrainement();
        updateTheme();
      });
    });

    backBtn.addEventListener("click", () => {
      currentExerciseId = null;
      document.getElementById("exerciseDetail").classList.remove("active");
      document.getElementById("entrainement").classList.add("active");
      tabButtons.forEach(b => b.classList.remove("active"));
      // 0 = Accueil, 1 = Entra√Ænement
      tabButtons[1].classList.add("active");
      currentView = "entrainement";
    });

    exportBtn.addEventListener("click", () => {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `muscle-boss-${new Date().toISOString().split("T")[0]}.json`;
      a.click();
    });

    importBtn.addEventListener("click", () => {
      importFileInput.click();
    });

    // ---- NOUVEL IMPORT SAIN ----
    importFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const json = JSON.parse(event.target.result);

          if (!json || !Array.isArray(json.logs)) {
            alert("‚ö†Ô∏è Fichier invalide : pas de propri√©t√© 'logs'.");
            return;
          }

          const importedLogs = json.logs;

          // Fusionner log par log (sans supprimer l'existant)
          const map = new Map();

          // 1) On indexe les logs existants
          state.logs.forEach(l => {
            const key = `${l.user}_${l.date}_${l.exerciseId}_${l.weight}_${l.reps}`;
            map.set(key, l);
          });

          // 2) On ajoute les logs du fichier (√©crase si m√™me cl√©)
          importedLogs.forEach(l => {
            const key = `${l.user}_${l.date}_${l.exerciseId}_${l.weight}_${l.reps}`;
            map.set(key, {
              user: l.user,
              date: l.date,
              exerciseId: l.exerciseId,
              weight: Number(l.weight) || 0,
              reps: Number(l.reps) || 0,
              rpe: l.rpe != null ? Number(l.rpe) : null,
              mode: l.mode || null
            });
          });

          // 3) Mise √† jour du state
          state.logs = Array.from(map.values());

          saveState();
          renderEntrainement();
          renderHistory();
          renderStatistics();
          renderProgression();

          alert("‚úÖ Import termin√© (fusion des donn√©es r√©ussie).");
        } catch (err) {
          console.error(err);
          alert("‚ö†Ô∏è Erreur lors de la lecture du fichier JSON.");
        }
      };

      reader.readAsText(file, "utf-8");
      importFileInput.value = "";
    });

    modalClose.addEventListener("click", () => {
      modalOverlay.classList.remove("show");
      if (modalChart) {
        modalChart.destroy();
        modalChart = null;
      }
    });

    fatigueSelect.addEventListener("change", (e) => {
      state.fatigue = e.target.value;
      saveState();
      renderEntrainement();
    });

        // ========== SUGGESTIONS AVANT S√âANCE ==========

        function getLastSessionForExercise(user, exerciseId, beforeDate) {
          const logs = state.logs.filter(l =>
            l.user === user &&
            l.exerciseId === exerciseId &&
            l.date < beforeDate
          );
          if (logs.length === 0) return null;

          const dates = [...new Set(logs.map(l => l.date))].sort();
          const lastDate = dates[dates.length - 1];
          const dayLogs = logs.filter(l => l.date === lastDate);
          return { date: lastDate, logs: dayLogs };
        }

        function buildPreSessionSuggestion(exerciseId) {
          const session = getLastSessionForExercise(state.user, exerciseId, state.date);
          if (!session) {
            return "Aucune s√©ance pr√©c√©dente sur cet exercice ‚Äî suis le plan pr√©vu et reste en RPE 7‚Äì8.";
          }

          const logs = session.logs;
          let totalRPE = 0;
          let countRPE = 0;

          logs.forEach(l => {
            if (l.rpe != null) {
              totalRPE += l.rpe;
              countRPE++;
            }
          });

          const avgRPE = countRPE > 0 ? totalRPE / countRPE : null;

          // Top set : plus gros poids, puis plus de reps
          let topSet = null;
          logs.forEach(l => {
            if (!topSet) {
              topSet = l;
            } else if (l.weight > topSet.weight || (l.weight === topSet.weight && l.reps > topSet.reps)) {
              topSet = l;
            }
          });

          const dateStr = new Date(session.date).toLocaleDateString("fr-FR");
          const fatigue = state.fatigue || "normal";

          let adviceCore = "";

          if (!avgRPE) {
            if (fatigue === "fresh") {
              adviceCore = "Tu peux viser un peu plus lourd (+2.5 kg) ou +1‚Äì2 reps sur 1‚Äì2 s√©ries.";
            } else if (fatigue === "normal") {
              adviceCore = "R√©p√®te la s√©ance et essaie simplement de faire un peu mieux sur la meilleure s√©rie.";
            } else if (fatigue === "tired") {
              adviceCore = "Garde la m√™me charge et focus technique, pas besoin de record aujourd'hui.";
            } else {
              adviceCore = "All√®ge l√©g√®rement (-5 √† -10%) ou enl√®ve 1 s√©rie pour privil√©gier la r√©cup.";
            }
          } else if (avgRPE <= 7.5) {
            if (fatigue === "fresh") {
              adviceCore = "Marge confortable : vise +2.5 kg ou +2 reps sur ta meilleure s√©rie.";
            } else if (fatigue === "normal") {
              adviceCore = "Progression l√©g√®re : +1 rep ou +2.5 kg sur la top set si tout va bien.";
            } else {
              adviceCore = "M√™me perf que la derni√®re fois suffit, ne cherche pas √† pousser plus.";
            }
          } else if (avgRPE <= 8.5) {
            if (fatigue === "fresh") {
              adviceCore = "Zone id√©ale : essaie de reproduire la s√©ance et de gratter 1 rep sur la top set.";
            } else if (fatigue === "normal") {
              adviceCore = "Stabilise : refais la m√™me perf proprement, sans chercher √† monter.";
            } else {
              adviceCore = "Garde la m√™me charge, et accepte 1 rep de moins sur la derni√®re s√©rie si besoin.";
            }
          } else {
            if (fatigue === "fresh") {
              adviceCore = "Tu √©tais d√©j√† tr√®s proche de l'√©chec : privil√©gie la qualit√© plut√¥t que d'augmenter encore.";
            } else if (fatigue === "normal") {
              adviceCore = "Reste un peu en dessous de la derni√®re s√©ance (charge -5% ou 1 s√©rie en moins).";
            } else {
              adviceCore = "S√©ance de gestion : baisse la charge de 5‚Äì10% ou enl√®ve une s√©rie.";
            }
          }

          const base = `Derni√®re s√©ance le ${dateStr} : ${logs.length} s√©ries, top set ${topSet.weight}kg √ó ${topSet.reps} reps${topSet.rpe ? ` (RPE ${topSet.rpe})` : ""}${avgRPE ? `, RPE moyen ${avgRPE.toFixed(1)}` : ""}.`;
          return base + " " + adviceCore;
        }

        function getModeLabel(mode) {
          switch (mode) {
            case "per_arm":
              return "par bras";
            case "bodyweight":
              return "au poids du corps";
            case "virtual":
              return "virtuel (abdos / sans leste)";
            case "total":
            default:
              return "en charge totale";
          }
        }

        // ========== DASHBOARD ACCUEIL ==========
        function renderHome() {
          if (!homeGrid) return;

          const user = state.user;
          if (homeCurrentUser) {
            homeCurrentUser.textContent = user;
          }
          renderFifaCard();
          homeCurrentUser.textContent = user;

          const userLogs = state.logs.filter(l => l.user === user);
          if (userLogs.length > 0) {
            const dates = [...new Set(userLogs.map(l => l.date))].sort();
            state.date = dates[dates.length - 1];
          }
          saveState();

          // Pas encore de donn√©es
          if (userLogs.length === 0) {
            homeGrid.innerHTML = `
              <div class="progression-card">
                <h3>${user}</h3>
                <p class="subtext">Aucune s√©ance enregistr√©e pour l‚Äôinstant.</p>
                <p class="subtext">Commence par aller dans l‚Äôonglet <strong>‚ÄúEntra√Ænement‚Äù</strong> pour logguer ta premi√®re s√©ance.</p>
              </div>
            `;
            return;
          }

          // Derni√®re s√©ance (par date)
          const uniqueDates = [...new Set(userLogs.map(l => l.date))].sort();
          const lastDate = uniqueDates[uniqueDates.length - 1];
          const lastLogs = userLogs.filter(l => l.date === lastDate);

          let lastVolume = 0;
          let lastReps = 0;
          lastLogs.forEach(l => {
            const w = Number(l.weight) || 0;
            const r = Number(l.reps) || 0;
            lastVolume += w * r;
            lastReps += r;
          });

          // IPG sur 30 jours
          const ipgData = computeIPG(user); // tu l'as d√©j√† dans ton fichier

          // S√©ance actuelle s√©lectionn√©e (A/B/C)
          const currentDay = program[state.currentDay];
          const nextDayName = currentDay ? currentDay.name : "Programme actuel";

          homeGrid.innerHTML = `
            <div class="progression-card">
              <h3>Derni√®re s√©ance</h3>
              <p class="subtext"><strong>${lastDate}</strong></p>
              <p class="subtext">
                Volume : <strong>${lastVolume.toFixed(0)} kg</strong><br>
                S√©ries : <strong>${lastLogs.length}</strong> ¬∑ R√©p√©titions : <strong>${lastReps}</strong>
              </p>
            </div>

            <div class="progression-card">
              <h3>IPG (30 derniers jours)</h3>
              <p class="subtext">
                IPG : <strong>${ipgData.ipg.toFixed(0)}</strong><br>
                S√©ances : <strong>${ipgData.sessions}</strong><br>
                Volume total : <strong>${ipgData.totalVolume.toFixed(0)} kg</strong>
              </p>
            </div>

            <div class="progression-card">
              <h3>Prochaine s√©ance</h3>
              <p class="subtext">
                Programme s√©lectionn√© :<br>
                <strong>${nextDayName}</strong>
              </p>
              <p class="subtext">
                Date du jour : <strong>${state.date}</strong><br>
                üëâ Va dans l‚Äôonglet <strong>‚ÄúEntra√Ænement‚Äù</strong> pour enregistrer cette s√©ance.
              </p>
            </div>
          `;
        }

        // Calcule les scores par muscle pour un user (0‚Äì100 comme base brute)
        function computeMuscleScoresForFifa(user) {
          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - 30);
          const cutoffStr = cutoff.toISOString().split("T")[0];

          const logs = state.logs.filter(l => l.user === user && l.date >= cutoffStr);
          const muscles = ["Pecs","Dos","Quadriceps","Ischios","√âpaules","Biceps","Triceps","Abdos","Cardio"];
          const byMuscle = {};
          muscles.forEach(m => byMuscle[m] = 0);

          muscles.forEach(muscle => {
            const mLogs = logs.filter(l => exerciseToMuscle[l.exerciseId] === muscle);
            if (mLogs.length === 0) {
              byMuscle[muscle] = 0;
              return;
            }
            let best1RM = 0;
            mLogs.forEach(l => {
              const est = estimateLog1RM(l);
              if (est > best1RM) best1RM = est;
            });
            const ref = musclePerformanceRef[muscle] || 0;
            byMuscle[muscle] = ref ? clamp((best1RM / ref) * 100, 0, 100) : 0;
          });

          return byMuscle;
        }

        // R√©cup√©rer la d√©finition d'un exercice √† partir de son id
        function getExerciseDefinition(exerciseId) {
          for (const dayKey in program) {
            const day = program[dayKey];
            const found = day.exercises.find(ex => ex.id === exerciseId);
            if (found) return found;
          }
          return null;
        }

        // Calcul des notes FIFA par exercice (30 derniers jours)
        function computeFifaExerciseScoresForUser(user) {
          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - 30);
          const cutoffStr = cutoff.toISOString().split("T")[0];

          const logs = state.logs.filter(
            l => l.user === user && l.date >= cutoffStr
          );
          if (logs.length === 0) return [];

          // Regrouper par exerciseId
          const byExercise = {};
          logs.forEach(log => {
            if (!byExercise[log.exerciseId]) {
              byExercise[log.exerciseId] = [];
            }
            byExercise[log.exerciseId].push(log);
          });

          const results = [];

          Object.entries(byExercise).forEach(([exerciseId, exLogs]) => {
            const def = getExerciseDefinition(exerciseId);
            if (!def) return;

            // On r√©cup√®re le muscle associ√©
            const muscle = def.muscle || exerciseToMuscle[exerciseId];
            const muscleRef = musclePerformanceRef[muscle] || 0;
            if (!muscleRef) return;

            // meilleure "force" sur 30 jours (1RM estim√©e)
            let best1RM = 0;
            exLogs.forEach(log => {
              const est = estimateLog1RM(log);
              if (est > best1RM) best1RM = est;
            });

            if (best1RM <= 0) return;

            // Ratio par rapport √† la m√™me r√©f que le muscle
            const ratio = clamp(best1RM / muscleRef, 0, 1);
            const score = Math.round(ratio * 100);  // m√™me logique que les muscles

            results.push({
              id: exerciseId,
              name: def.name || exerciseId,
              muscle: muscle,
              score
            });
          });

          // Trier du meilleur au moins bon
          results.sort((a, b) => b.score - a.score);
          return results;
        }

        // Transforme en notes fa√ßon FIFA (PEC, DOS, JAM, EPA, TRI, BIC, ABD, CAR, GEN)
        function getFifaStats(user) {
          const ipgData = computeIPG(user);
          const byMuscle = computeMuscleScoresForFifa(user);

          const PEC = Math.round(byMuscle["Pecs"]);
          const DOS = Math.round(byMuscle["Dos"]);
          const EPA = Math.round(byMuscle["√âpaules"]);
          const TRI = Math.round(byMuscle["Triceps"]);
          const BIC = Math.round(byMuscle["Biceps"]);
          const ABD = Math.round(byMuscle["Abdos"] || 0);
          const JAM = Math.round((byMuscle["Quadriceps"] + byMuscle["Ischios"]) / 2 || 0);
          const CAR = Math.round(byMuscle["Cardio"] || 0);

          // Base ¬´ globale brute ¬ª
          const averageBase = (PEC + DOS + EPA + TRI + BIC + ABD + JAM + CAR + ipgData.ipg) / 9 || 0;

          // On comprime comme dans FIFA : plut√¥t 40‚Äì94 que 0‚Äì100
          let GEN = Math.round(30 + averageBase * 0.6);
          GEN = clamp(GEN, 40, 94);

          return { GEN, PEC, DOS, EPA, TRI, BIC, ABD, JAM, CAR };
        }

        function renderFifaCard() {
          const cardEl = document.getElementById("fifaCard");
          const detailsGrid = document.getElementById("fifaDetailsGrid");
          const currentUser = state.user;

          if (!cardEl || !detailsGrid) return;

          const userLogs = state.logs.filter(l => l.user === currentUser);
          if (userLogs.length === 0) {
            cardEl.innerHTML = `
              <div class="fifa-card-placeholder">
                Aucune s√©ance enregistr√©e pour <strong>${currentUser}</strong>.<br>
                Va dans l‚Äôonglet <strong>Entra√Ænement</strong> pour commencer.
              </div>
            `;
            detailsGrid.innerHTML = "";
            return;
          }

          const stats = getFifaStats(currentUser);
          const ipgData = computeIPG(currentUser);

          // Photo
          let photoHtml = "";
          if (playerProfile.photoDataUrl) {
            photoHtml = `<img src="${playerProfile.photoDataUrl}" alt="photo joueur" />`;
          } else {
            photoHtml = `<div class="fifa-photo-placeholder">üí™</div>`;
          }

          cardEl.innerHTML = `
            <div class="fifa-card-header">
              <div class="fifa-gen">
                <div class="fifa-gen-label">GEN</div>
                <div class="fifa-gen-value">${stats.GEN}</div>
                <div class="fifa-meta">${currentUser}</div>
                <div class="fifa-meta" style="font-size:0.7rem; opacity:0.8;">
                  IPG: ${ipgData.ipg.toFixed(0)} ¬∑ S√©ances: ${ipgData.sessions}
                </div>
              </div>
              <div>
                <div class="fifa-photo">${photoHtml}</div>
                <div class="fifa-name">${playerProfile.name || currentUser}</div>
                <div class="fifa-flags">
                  <span>${playerProfile.flag || "üè≥Ô∏è"}</span>
                  <span>¬∑</span>
                  <span>${playerProfile.club || "MuscleBoss Gym"}</span>
                </div>
              </div>
            </div>

            <div class="fifa-stats">
              <div class="fifa-stat-line"><span class="fifa-stat-label">PEC</span><span class="fifa-stat-value">${stats.PEC}</span></div>
              <div class="fifa-stat-line"><span class="fifa-stat-label">DOS</span><span class="fifa-stat-value">${stats.DOS}</span></div>
              <div class="fifa-stat-line"><span class="fifa-stat-label">JAM</span><span class="fifa-stat-value">${stats.JAM}</span></div>
              <div class="fifa-stat-line"><span class="fifa-stat-label">EPA</span><span class="fifa-stat-value">${stats.EPA}</span></div>
              <div class="fifa-stat-line"><span class="fifa-stat-label">TRI</span><span class="fifa-stat-value">${stats.TRI}</span></div>
              <div class="fifa-stat-line"><span class="fifa-stat-label">BIC</span><span class="fifa-stat-value">${stats.BIC}</span></div>

              <!-- Ligne du dessous : ABD & CAR centr√©s -->
              <div class="fifa-stat-line fifa-stat-abd">
                <span class="fifa-stat-label">ABD</span>
                <span class="fifa-stat-value">${stats.ABD}</span>
              </div>
              <div class="fifa-stat-line fifa-stat-car">
                <span class="fifa-stat-label">CAR</span>
                <span class="fifa-stat-value">${stats.CAR}</span>
              </div>
            </div>
          `;

          // D√©tails (verso : m√™me infos mais list√©es proprement)
          const exerciseScores = computeFifaExerciseScoresForUser(currentUser);

          let htmlDetails = `
            <div class="fifa-section-title">Groupes musculaires</div>
            ${buildFifaBarRow("PEC (pectoraux)", stats.PEC)}
            ${buildFifaBarRow("JAM (quadriceps + ischios)", stats.JAM)}
            ${buildFifaBarRow("DOS", stats.DOS)}
            ${buildFifaBarRow("√âPAULES", stats.EPA)}
            ${buildFifaBarRow("TRI (triceps)", stats.TRI)}
            ${buildFifaBarRow("BIC (biceps)", stats.BIC)}
            ${buildFifaBarRow("ABDOS", stats.ABD)}
            ${buildFifaBarRow("CARDIO", stats.CAR)}
          `;

          if (exerciseScores.length > 0) {
            htmlDetails += `
              <div class="fifa-section-title" style="margin-top:8px;">
                Par exercice (30 derniers jours)
              </div>
            `;

            exerciseScores.forEach(ex => {
              htmlDetails += buildFifaBarRow(ex.name, ex.score);
            });
          }

          detailsGrid.innerHTML = htmlDetails;
        }

        function setupProfileInputs() {
          const nameInput = document.getElementById("profileNameInput");
          const flagInput = document.getElementById("profileFlagInput");
          const clubInput = document.getElementById("profileClubInput");
          const photoInput = document.getElementById("profilePhotoInput");
          const detailsBtn = document.getElementById("fifaDetailsBtn");
          const detailsPanel = document.getElementById("fifaDetailsPanel");
          const detailsClose = document.getElementById("fifaDetailsClose");

          if (!nameInput) return; // l‚Äôonglet n‚Äôest peut-√™tre pas rendu encore

          // Pr√©-remplir
          nameInput.value = playerProfile.name;
          flagInput.value = playerProfile.flag;
          clubInput.value = playerProfile.club;

          nameInput.addEventListener("input", () => {
            playerProfile.name = nameInput.value;
            savePlayerProfile();
            renderFifaCard();
          });

          flagInput.addEventListener("input", () => {
            playerProfile.flag = flagInput.value;
            savePlayerProfile();
            renderFifaCard();
          });

          clubInput.addEventListener("input", () => {
            playerProfile.club = clubInput.value;
            savePlayerProfile();
            renderFifaCard();
          });

          photoInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
              playerProfile.photoDataUrl = ev.target.result;
              savePlayerProfile();
              renderFifaCard();
            };
            reader.readAsDataURL(file);
          });

          if (detailsBtn && detailsPanel && detailsClose) {
            detailsBtn.addEventListener("click", () => {
              detailsPanel.classList.add("open");
            });
            detailsClose.addEventListener("click", () => {
              detailsPanel.classList.remove("open");
            });
          }
        }

    // ========== RENDER FUNCTIONS ==========
    function renderEntrainement() {
      const day = program[state.currentDay];
      exercisesContainer.innerHTML = `<div class="section-title">${day.name}</div>`;

      let totalVolume = 0;
      let totalSets = 0;
      let totalReps = 0;

      day.exercises.forEach(exercise => {
        const exerciseLogs = state.logs.filter(
          l => l.user === state.user && l.date === state.date && l.exerciseId === exercise.id
        );

        // üëâ D√©terminer le mode par d√©faut pour cet exercice
        let lastLogMode = null;
        if (exerciseLogs.length > 0) {
          const lastLog = exerciseLogs[exerciseLogs.length - 1];
          if (lastLog.mode) {
            lastLogMode = lastLog.mode;
          }
        }

        const defaultMode = lastLogMode || exercise.recommendedMode || "total";

        let exerciseVolume = 0;
        exerciseLogs.forEach(l => {
          const effW = getEffectiveWeightForVolume(l);
          const r = Number(l.reps) || 0;
          exerciseVolume += effW * r;
          totalSets++;
          totalReps += r;
        });

        totalVolume += exerciseVolume;

        const card = document.createElement("div");
        card.className = "exercise-card";

      const notesArnaud = exercise.notesArnaud || "";
      const notesDancho = exercise.notesDancho || "";

        
        card.innerHTML = `
          <div class="exercise-header">
            <div class="exercise-name" data-exercise-id="${exercise.id}">${exercise.name}</div>
            <div class="tag">${exercise.muscle}</div>
          </div>

          ${exercise.gifUrl ? `
            <div class="gif-wrapper">
              <img src="${exercise.gifUrl}" alt="${exercise.name}" class="exercise-gif" />
            </div>
          ` : ""}

          <div class="notes">
            <span><strong>Arnaud :</strong> ${notesArnaud}</span>
            <span><strong>Dancho :</strong> ${notesDancho}</span>
          </div>

          <!-- S√©lecteur de mode de charge -->
          <div class="subtext" style="margin-top:6px; margin-bottom:2px;">
            <label for="mode-${exercise.id}" style="font-size:0.8rem; color:#9ca3af;">
              Poids √† noter :
            </label>
            <select id="mode-${exercise.id}" style="margin-left:6px; padding:2px 4px; font-size:0.8rem; border-radius:4px;">
              <option value="total" ${defaultMode === "total" ? "selected" : ""}>Charge totale</option>
              <option value="per_arm" ${defaultMode === "per_arm" ? "selected" : ""}>Par bras</option>
              <option value="bodyweight" ${defaultMode === "bodyweight" ? "selected" : ""}>Poids du corps</option>
              <option value="virtual" ${defaultMode === "virtual" ? "selected" : ""}>Virtuel (abdos)</option>
            </select>
          </div>

          <!-- Petit rappel du mode recommand√© -->
          <div class="subtext" style="font-size:0.75rem; color:#6b7280; margin-bottom:6px;">
            Mode recommand√© : <strong>${getModeLabel(exercise.recommendedMode || "total")}</strong> (modifiable).
          </div>

          <!-- Suggestion AVANT s√©ance -->
          <div class="suggestion">
            ${buildPreSessionSuggestion(exercise.id)}
          </div>

          <div class="logs">
            ${exerciseLogs.length > 0 ? exerciseLogs.map((log, idx) => {
              const globalIdx = state.logs.indexOf(log);
              return `
                <div class="log-item">
                  <span>${log.weight}kg √ó ${log.reps} reps${log.rpe ? ` (RPE ${log.rpe})` : ''}</span>
                  <button class="delete-btn" onclick="deleteLog(${globalIdx})">üóëÔ∏è</button>
                </div>
              `;
            }).join('') : '<div class="log-empty">Aucune s√©rie enregistr√©e</div>'}
          </div>

          <div class="log-form">
            <div class="log-form-row">
              <input type="number" placeholder="Poids (kg)" id="weight-${exercise.id}" />
              <input type="number" placeholder="Reps" id="reps-${exercise.id}" />
              <input type="number" placeholder="RPE (1-10)" id="rpe-${exercise.id}" min="1" max="10" />
            </div>
            <button class="add-set" onclick="addSet('${exercise.id}')">‚ûï Ajouter s√©rie</button>
          </div>

          <div class="suggestion" id="suggestion-${exercise.id}"></div>
        `;

        card.querySelector(".exercise-name").addEventListener("click", () => {
          currentExerciseId = exercise.id;
          document.getElementById("entrainement").classList.remove("active");
          document.getElementById("exerciseDetail").classList.add("active");
          renderExerciseDetail();
        });

        exercisesContainer.appendChild(card);
      });

      summaryEl.innerHTML = `
        <strong>Volume total:</strong> ${totalVolume.toFixed(0)} kg ¬∑ 
        <strong>S√©ries:</strong> ${totalSets} ¬∑ 
        <strong>R√©p√©titions:</strong> ${totalReps}
      `;
    }

    function renderStatistics() {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 30);
      const cutoffStr = cutoff.toISOString().split("T")[0];

      const recentLogs = state.logs.filter(l => l.date >= cutoffStr);

      const muscles = [
        "Pecs",
        "Dos",
        "Quadriceps",
        "Ischios",
        "√âpaules",
        "Biceps",
        "Triceps",
        "Abdos",
        "Cardio"
      ];

      // 1RM max par muscle et par user, sur les 30 derniers jours
      function computeMusclePerformance(user, muscle) {
        const logs = recentLogs.filter(l => {
          const m = exerciseToMuscle[l.exerciseId];
          return l.user === user && m === muscle;
        });

        if (logs.length === 0) return 0;

        let best1RM = 0;
        logs.forEach(l => {
          const w1 = getEffectiveWeightFor1RM(l);
          const r = Number(l.reps) || 0;
          const est = estimate1RM(w1, r);
          if (est > best1RM) best1RM = est;
        });

        const ref = musclePerformanceRef[muscle] || 0;
        if (!ref) return 0;

        const score = (best1RM / ref) * 100;
        return clamp(score, 0, 100); // 0‚Äì100%
      }

      const dataArnaud = muscles.map(m => computeMusclePerformance("Arnaud", m));
      const dataDancho = muscles.map(m => computeMusclePerformance("Dancho", m));

      const ctx = radarChartCanvas.getContext("2d");
      if (radarChart) {
        radarChart.destroy();
      }

      radarChart = new Chart(ctx, {
        type: "radar",
        data: {
          labels: muscles,
          datasets: [
            {
              label: "Arnaud",
              data: dataArnaud,
              borderColor: "#1a1833",
              backgroundColor: "rgba(27, 201, 199, 0.18)",
              borderWidth: 3,
              pointRadius: 5,
              pointBackgroundColor: "#1a1833"
            },
            {
              label: "Dancho",
              data: dataDancho,
              borderColor: "#E8E8E8",
              backgroundColor: "rgba(232, 232, 232, 0.15)",
              borderWidth: 3,
              pointRadius: 5,
              pointBackgroundColor: "#E8E8E8"
            }
          ]
        },
        options: {
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 100,
              ticks: { stepSize: 20, display: true, color: "#9ca3af" },
              grid: { circular: true, color: "rgba(255, 255, 255, 0.1)" },
              pointLabels: { color: "#e5e7eb", font: { size: 12 } }
            }
          },
          plugins: {
            legend: { 
              position: "top",
              labels: { color: "#e5e7eb", font: { size: 14 } }
            }
          },
          onClick: () => {
            openModal("Performance Globale (30 jours)", "radar", {
              labels: muscles,
              datasets: [
                {
                  label: "Arnaud",
                  data: dataArnaud,
                  borderColor: "#1a1833",
                  backgroundColor: "rgba(0, 255, 136, 0.2)",
                  borderWidth: 3,
                  pointRadius: 5
                },
                {
                  label: "Dancho",
                  data: dataDancho,
                  borderColor: "#E8E8E8",
                  backgroundColor: "rgba(0, 212, 255, 0.2)",
                  borderWidth: 3,
                  pointRadius: 5
                }
              ]
            });
          }
        }
      });

      // Voix + IPG + badges pour l'utilisateur s√©lectionn√©
      renderIPGAndBadges(state.user, muscles, {
        Arnaud: dataArnaud,
        Dancho: dataDancho
      });
    }

    function renderHistory() {
      historyList.innerHTML = "";

      if (state.logs.length === 0) {
        historyList.innerHTML = '<div style="text-align:center; color:#9ca3af;">Aucun historique disponible</div>';
        return;
      }

      const groupedByDate = {};
      state.logs.forEach(log => {
        if (!groupedByDate[log.date]) {
          groupedByDate[log.date] = [];
        }
        groupedByDate[log.date].push(log);
      });

      const dates = Object.keys(groupedByDate).sort().reverse();

      dates.forEach(date => {
        const logs = groupedByDate[date];
        const item = document.createElement("div");
        item.className = "history-item";
        
        let exercisesList = '';
        const exerciseGroups = {};
        logs.forEach(log => {
          if (!exerciseGroups[log.exerciseId]) {
            exerciseGroups[log.exerciseId] = [];
          }
          exerciseGroups[log.exerciseId].push(log);
        });

        Object.entries(exerciseGroups).forEach(([exId, exLogs]) => {
          let exerciseName = exId;
          Object.values(program).forEach(day => {
            day.exercises.forEach(ex => {
              if (ex.id === exId) exerciseName = ex.name;
            });
          });
          
          const volume = exLogs.reduce((sum, l) => {
            const effW = getEffectiveWeightForVolume(l);
            const r = Number(l.reps) || 0;
            return sum + effW * r;
          }, 0);

          exercisesList += `<div class="history-exercise">${exerciseName}: ${exLogs.length} s√©ries ¬∑ ${volume.toFixed(0)} kg</div>`;
        });

        item.innerHTML = `
          <div class="history-date">${new Date(date).toLocaleDateString('fr-FR')}</div>
          ${exercisesList}
        `;
        
        historyList.appendChild(item);
      });
    }

    // Calcule une "note d'IPG de s√©ance" (0‚Äì100) pour chaque date d'un utilisateur
    function computeSessionIPGSeries(user) {
      const logs = state.logs.filter(l => l.user === user);
      if (logs.length === 0) {
        return { dates: [], values: [] };
      }

      const sessionsByDate = {};
      logs.forEach(l => {
        if (!sessionsByDate[l.date]) sessionsByDate[l.date] = [];
        sessionsByDate[l.date].push(l);
      });

      const dates = Object.keys(sessionsByDate).sort();
      const values = [];

      const targetSessionVolume = 6000; // volume "r√©f√©rence" pour 100/100

      dates.forEach(date => {
        const dayLogs = sessionsByDate[date];
        let volume = 0;
        let totalRPE = 0;
        let countRPE = 0;

        dayLogs.forEach(l => {
          const effW = getEffectiveWeightForVolume(l);
          const r = Number(l.reps) || 0;
          volume += effW * r;
          if (l.rpe != null) {
            totalRPE += Number(l.rpe);
            countRPE++;
          }
        });

        const volIndex = clamp((volume / targetSessionVolume) * 100, 0, 120);
        const avgRPE = countRPE > 0 ? totalRPE / countRPE : 7.5;
        const intensityIndex = clamp((avgRPE / 9) * 100, 0, 120);

        // IPG de s√©ance = moyenne volume + intensit√©
        const sessionIPG = Math.round((volIndex + intensityIndex) / 2);
        values.push(sessionIPG);
      });

      return { dates, values };
    }

    // Dessine le comparatif Arnaud vs Dancho dans l'onglet Progression
    function renderIPGComparison() {
      const arnaudSeries = computeSessionIPGSeries("Arnaud");
      const danchoSeries = computeSessionIPGSeries("Dancho");

      const allDatesSet = new Set([
        ...arnaudSeries.dates,
        ...danchoSeries.dates
      ]);
      const allDates = Array.from(allDatesSet).sort();

      if (allDates.length === 0) {
        const info = document.getElementById("ipgComparisonInfo");
        info.textContent = "Pas encore assez de s√©ances pour tracer une √©volution.";
        if (ipgComparisonChart) {
          ipgComparisonChart.destroy();
          ipgComparisonChart = null;
        }
        return;
      }

      const dataArnaud = allDates.map(d => {
        const idx = arnaudSeries.dates.indexOf(d);
        return idx !== -1 ? arnaudSeries.values[idx] : null;
      });

      const dataDancho = allDates.map(d => {
        const idx = danchoSeries.dates.indexOf(d);
        return idx !== -1 ? danchoSeries.values[idx] : null;
      });

      const ctx = document.getElementById("ipgComparisonChart").getContext("2d");
      if (ipgComparisonChart) {
        ipgComparisonChart.destroy();
      }

      const isArnaudSelected = state.user === "Arnaud";
      const isDanchoSelected = state.user === "Dancho";

      ipgComparisonChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: allDates,
          datasets: [
            {
              label: "Arnaud",
              data: dataArnaud,
              borderColor: "#1a1833",
              backgroundColor: "rgba(0, 255, 136, 0.1)",
              borderWidth: isArnaudSelected ? 3 : 1.5,
              pointRadius: isArnaudSelected ? 4 : 2,
              spanGaps: true,
              tension: 0.3
            },
            {
              label: "Dancho",
              data: dataDancho,
              borderColor: "#E8E8E8",
              backgroundColor: "rgba(0, 212, 255, 0.1)",
              borderWidth: isDanchoSelected ? 3 : 1.5,
              pointRadius: isDanchoSelected ? 4 : 2,
              spanGaps: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" }
            }
          },
          scales: {
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.2)" }
            },
            y: {
              suggestedMin: 0,
              suggestedMax: 120,
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(148, 163, 184, 0.2)" }
            }
          }
        }
      });

      const info = document.getElementById("ipgComparisonInfo");
      info.innerHTML = `
        Courbes : <span style="color:#1a1833;">Arnaud</span> vs
        <span style="color:#E8E8E8;">Dancho</span> ‚Äî l'utilisateur s√©lectionn√© en haut est mis en avant (ligne plus √©paisse).
      `;
    }

    function renderProgression() {
      progressionGrid.innerHTML = "";

      const users = ["Arnaud", "Dancho"];
      users.forEach(user => {
        const userLogs = state.logs.filter(l => l.user === user);
        
        if (userLogs.length === 0) {
          progressionGrid.innerHTML += `
            <div class="progression-card">
              <h3>${user}</h3>
              <div style="color:#9ca3af;">Aucune donn√©e disponible</div>
            </div>
          `;
          return;
        }

        let totalVolume = 0;
        let totalSets = userLogs.length;
        const uniqueDates = new Set(userLogs.map(l => l.date));
        const sessions = uniqueDates.size;

        userLogs.forEach(l => {
          const effW = getEffectiveWeightForVolume(l);
          const r = Number(l.reps) || 0;
          totalVolume += effW * r;
        });

        const avgVolumePerSession = sessions > 0 ? totalVolume / sessions : 0;

        const card = document.createElement("div");
        card.className = "progression-card";
        card.innerHTML = `
          <h3>${user}</h3>
          <div class="stat-row">
            <span class="stat-label">Volume total</span>
            <span class="stat-value">${totalVolume.toFixed(0)} kg</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">S√©ries totales</span>
            <span class="stat-value">${totalSets}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">S√©ances</span>
            <span class="stat-value">${sessions}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Volume moyen/s√©ance</span>
            <span class="stat-value">${avgVolumePerSession.toFixed(0)} kg</span>
          </div>
        `;

        progressionGrid.appendChild(card);
      });

       // Apr√®s avoir rempli les cartes, on met √† jour le graphe comparatif
      renderIPGComparison();
    }

    function renderExerciseDetail() {
      if (!currentExerciseId) return;

      let exercise = null;
      Object.values(program).forEach(day => {
        day.exercises.forEach(exo => {
          if (exo.id === currentExerciseId) exercise = exo;
        });
      });

      if (!exercise) {
        exerciseDetailTitle.textContent = "Exercice introuvable";
        exerciseStats.textContent = "";
        return;
      }

      exerciseDetailTitle.textContent = exercise.name;

      const datesSet = new Set();
      state.logs.forEach(l => {
        if (l.exerciseId === currentExerciseId) {
          datesSet.add(l.date);
        }
      });

      const dates = Array.from(datesSet).sort();

      function getBest1RMForUserOnDate(user, date) {
        const logs = state.logs.filter(
          l => l.user === user && l.exerciseId === currentExerciseId && l.date === date
        );
        let best = 0;
        logs.forEach(l => {
          const w1 = getEffectiveWeightFor1RM(l);
          const r = Number(l.reps) || 0;
          const est = estimate1RM(w1, r);
          if (est > best) best = est;
        });
        return best;
      }

      const dataArnaud = dates.map(d => getBest1RMForUserOnDate("Arnaud", d) || null);
      const dataDancho = dates.map(d => getBest1RMForUserOnDate("Dancho", d) || null);

      const ctx = document.getElementById("exerciseChart").getContext("2d");
      if (exerciseChart) {
        exerciseChart.destroy();
      }

      if (dates.length === 0) {
        exerciseStats.textContent = "Aucune donn√©e enregistr√©e pour cet exercice.";
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }

      exerciseChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            {
              label: "Arnaud ‚Äî 1RM estim√©e",
              data: dataArnaud,
              borderColor: "#1a1833",
              backgroundColor: "rgba(0, 255, 136, 0.1)",
              borderWidth: 2,
              spanGaps: true,
              tension: 0.3
            },
            {
              label: "Dancho ‚Äî 1RM estim√©e",
              data: dataDancho,
              borderColor: "#E8E8E8",
              backgroundColor: "rgba(0, 212, 255, 0.1)",
              borderWidth: 2,
              spanGaps: true,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // üëà AJOUT IMPORTANT
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "1RM estim√©e (kg)",
                color: "#e5e7eb"
              },
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(255, 255, 255, 0.1)" }
            },
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(255, 255, 255, 0.1)" }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" }
            }
          }
        }
      });

            const bestArnaud = Math.max(...dataArnaud.filter(v => v !== null));
      const bestDancho = Math.max(...dataDancho.filter(v => v !== null));

      // === Derni√®re s√©ance compl√®te par utilisateur sur cet exercice ===
      function getLastSessionForExercise(user) {
        const logs = state.logs.filter(
          l => l.user === user && l.exerciseId === currentExerciseId
        );
        if (logs.length === 0) return null;

        const dates = [...new Set(logs.map(l => l.date))].sort();
        const lastDate = dates[dates.length - 1];
        const dayLogs = logs.filter(l => l.date === lastDate);

        return { date: lastDate, logs: dayLogs };
      }

      function formatSession(session) {
        if (!session) {
          return `<div style="color:#9ca3af;"><em>Aucune s√©ance enregistr√©e.</em></div>`;
        }

        const dateStr = new Date(session.date).toLocaleDateString("fr-FR");
        const setsHtml = session.logs.map((l, idx) => {
          const rpePart = l.rpe != null ? ` (RPE ${l.rpe})` : "";
          return `<div>- S√©rie ${idx + 1} : ${l.weight}kg √ó ${l.reps} reps${rpePart}</div>`;
        }).join("");

        return `
          <div style="margin-top:2px;">
            <span style="color:#E8E8E8;">${dateStr}</span>
            ${setsHtml}
          </div>
        `;
      }

      const lastArnaud = getLastSessionForExercise("Arnaud");
      const lastDancho = getLastSessionForExercise("Dancho");

      exerciseStats.innerHTML = `
        <div><strong>Meilleure 1RM Arnaud:</strong> ${bestArnaud ? bestArnaud.toFixed(1) + " kg" : "‚Äî"}</div>
        <div><strong>Meilleure 1RM Dancho:</strong> ${bestDancho ? bestDancho.toFixed(1) + " kg" : "‚Äî"}</div>

        <hr style="border:none; border-top:1px solid rgba(148,163,184,0.4); margin:6px 0;">

        <div><strong>Derni√®re s√©ance Arnaud</strong></div>
        ${formatSession(lastArnaud)}

        <div style="margin-top:6px;"><strong>Derni√®re s√©ance Dancho</strong></div>
        ${formatSession(lastDancho)}
      `;
    }

    function computeIPG(user) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 30);
      const cutoffStr = cutoff.toISOString().split("T")[0];

      const logs = state.logs.filter(l => l.user === user && l.date >= cutoffStr);
      if (logs.length === 0) {
        return {
          ipg: 0,
          volumeIndex: 0,
          freqIndex: 0,
          intensityIndex: 0,
          sessions: 0,
          totalVolume: 0
        };
      }

      let totalVolume = 0;
      let totalRPE = 0;
      let countRPE = 0;
      const datesSet = new Set();

      logs.forEach(l => {
        const effW = getEffectiveWeightForVolume(l);
        const r = Number(l.reps) || 0;
        totalVolume += effW * r;
        datesSet.add(l.date);

        if (l.rpe != null) {
          totalRPE += Number(l.rpe);
          countRPE++;
        }
      });

      const sessions = datesSet.size;
      const avgRPE = countRPE > 0 ? totalRPE / countRPE : 7.5;

      const targetVolumeMonth = 60000; // 60 tonnes sur 30j = 100%
      const targetSessions = 12;       // 3 s√©ances / semaine

      const volumeIndex = clamp((totalVolume / targetVolumeMonth) * 100, 0, 100);
      const freqIndex   = clamp((sessions / targetSessions) * 100, 0, 100);
      const intensityIndex = clamp((avgRPE / 9) * 100, 0, 100);

      const ipg = Math.round((volumeIndex + freqIndex + intensityIndex) / 3);

      return {
        ipg,
        volumeIndex,
        freqIndex,
        intensityIndex,
        sessions,
        totalVolume: Math.round(totalVolume)
      };
    }

    function getUserBadges(user, ipgData) {
      const badges = [];

      if (ipgData.sessions >= 8) {
        badges.push({
          id: "consistency_1",
          label: "Soldat r√©gulier",
          desc: "Au moins 8 s√©ances sur les 30 derniers jours."
        });
      }

      if (ipgData.sessions >= 12) {
        badges.push({
          id: "consistency_2",
          label: "Machine √† la salle",
          desc: "Tu tournes √† plein r√©gime (‚â•12 s√©ances / 30j)."
        });
      }

      if (ipgData.totalVolume >= 40000) {
        badges.push({
          id: "volume_monster",
          label: "Volume Monster",
          desc: "Plus de 40 tonnes d√©plac√©es sur les 30 derniers jours."
        });
      }

      // Badge "PR Hunter" : si tu as au moins un exercice o√π la meilleure 1RM
      // r√©cente est > 90% du max historique
      let hasPR = false;

      // On calcule un max historique par exercice
      const allUserLogs = state.logs.filter(l => l.user === user);
      const maxByExercise = {};
      allUserLogs.forEach(l => {
        const w1 = getEffectiveWeightFor1RM(l);
        const r = Number(l.reps) || 0;
        const est = estimate1RM(w1, r);
        if (!maxByExercise[l.exerciseId] || est > maxByExercise[l.exerciseId]) {
          maxByExercise[l.exerciseId] = est;
        }
      });

      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 30);
      const cutoffStr = cutoff.toISOString().split("T")[0];
      const recentLogs = allUserLogs.filter(l => l.date >= cutoffStr);

      const bestRecentByExercise = {};
      recentLogs.forEach(l => {
        const w1 = getEffectiveWeightFor1RM(l);
        const r = Number(l.reps) || 0;
        const est = estimate1RM(w1, r);
        if (!bestRecentByExercise[l.exerciseId] || est > bestRecentByExercise[l.exerciseId]) {
          bestRecentByExercise[l.exerciseId] = est;
        }
      });

      Object.keys(bestRecentByExercise).forEach(exId => {
        const recent = bestRecentByExercise[exId];
        const maxHist = maxByExercise[exId] || 0;
        if (maxHist > 0 && recent >= 0.9 * maxHist) {
          hasPR = true;
        }
      });

      if (hasPR) {
        badges.push({
          id: "pr_hunter",
          label: "PR Hunter",
          desc: "Tu as fr√¥l√© ou battu certains de tes records r√©cemment."
        });
      }

      return badges;
    }

    function renderIPGAndBadges(user, muscles, perfDataByUser) {
      const ipgData = computeIPG(user);
      const ipgSummaryEl = document.getElementById("ipgSummary");
      const badgesContainer = document.getElementById("badgesContainer");

      const perfArray = perfDataByUser[user] || [];
      let bestMuscle = null;
      let bestScore = -1;
      let worstMuscle = null;
      let worstScore = 101;

      muscles.forEach((m, idx) => {
        const v = perfArray[idx];
        if (v > 0 && v > bestScore) {
          bestScore = v;
          bestMuscle = m;
        }
        if (v > 0 && v < worstScore) {
          worstScore = v;
          worstMuscle = m;
        }
      });

      // Voix de l'app selon IPG
      let mood;
      if (ipgData.ipg === 0) {
        mood = `${user}, j'ai besoin de plus de donn√©es pour te juger. Pour l'instant, l'histoire est vide.`;
      } else if (ipgData.ipg < 40) {
        mood = `${user}, phase creuse en ce moment. On reprend un rythme propre, sans se cramer, mais on arr√™te de dormir debout.`;
      } else if (ipgData.ipg < 70) {
        mood = `${user}, base solide. Tu construis quelque chose de s√©rieux, mais il reste beaucoup de marge. On peut pousser un cran plus loin sur la r√©gularit√©.`;
      } else {
        mood = `${user}, tr√®s bon niveau de r√©gularit√© et de charge. L√† on parle d'un vrai cycle d'athl√®te. Si on garde ce rythme, les perfs vont suivre.`;
      }

      let focusText = "";
      if (bestMuscle && worstMuscle && bestMuscle !== worstMuscle) {
        focusText = `Ton point fort actuel : <strong>${bestMuscle}</strong> (~${bestScore.toFixed(0)}%). 
    Ton point √† travailler : <strong>${worstMuscle}</strong> (~${worstScore.toFixed(0)}%).`;
      }

      ipgSummaryEl.innerHTML = `
        <div><strong>IPG (Indice de Progression Globale) :</strong> ${ipgData.ipg}/100</div>
        <div>Volume 30j : <strong>${ipgData.totalVolume} kg</strong> ¬∑ S√©ances : <strong>${ipgData.sessions}</strong></div>
        <div>D√©tail : Volume ${ipgData.volumeIndex}/100 ¬∑ Fr√©quence ${ipgData.freqIndex}/100 ¬∑ Intensit√© ${ipgData.intensityIndex}/100</div>
        <div style="margin-top:6px;">${mood}</div>
        ${focusText ? `<div style="margin-top:4px;">${focusText}</div>` : ""}
      `;

      const badges = getUserBadges(user, ipgData);
      if (badges.length === 0) {
        badgesContainer.innerHTML = `<div style="color:#9ca3af; text-align: center; padding: 10px;">Pas encore de badge d√©bloqu√©. Tu sais ce qu'il te reste √† faire üí™</div>`;
      } else {
        badgesContainer.innerHTML = `
          <div style="margin-bottom:10px; font-size: 0.95rem; font-weight: 700; color: #1a1833; text-align: center; letter-spacing: 0.05em;">üèÜ BADGES D√âBLOQU√âS üèÜ</div>
          ${badges.map(b => `
            <div class="badge-item">
              <div class="badge-icon">üèÖ</div>
              <div class="badge-content">
                <div class="badge-label">${b.label}</div>
                <div class="badge-desc">${b.desc}</div>
              </div>
            </div>
          `).join("")}
        `;
      }

      // On garde l'info "clique pour agrandir" dans dashInfo
      dashInfo.innerHTML = `<div>üí° Clique sur le radar pour l'agrandir en plein √©cran.</div>`;
    }

    function openModal(title, chartType, data) {
      modalTitle.textContent = title;
      modalOverlay.classList.add("show");
      
      if (modalChart) {
        modalChart.destroy();
      }

      const ctx = document.getElementById("modalChart").getContext("2d");
      modalChart = new Chart(ctx, {
        type: chartType,
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: chartType === "radar" ? {
            r: {
              suggestedMin: 0,
              suggestedMax: 100,
              ticks: { stepSize: 20, color: "#9ca3af" },
              grid: { color: "rgba(255, 255, 255, 0.1)" },
              pointLabels: { color: "#e5e7eb", font: { size: 14 } }
            }
          } : {
            y: {
              beginAtZero: true,
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(255, 255, 255, 0.1)" }
            },
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(255, 255, 255, 0.1)" }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb", font: { size: 16 } }
            }
          }
        }
      });
    }

        // ========== PR & SUGGESTIONS HELPERS ==========

    // Stats de PR pour un exercice donn√© (tous les logs de l'utilisateur)
    function computeExercisePRStats(user, exerciseId) {
      const logs = state.logs.filter(l => l.user === user && l.exerciseId === exerciseId);

      let best1RM = 0;
      let bestVolume = 0;          // meilleur "poids x reps" sur une seule s√©rie
      let best5RMWeight = 0;       // meilleur poids sur 5 reps
      let best10RMWeight = 0;      // meilleur poids sur 10 reps

      logs.forEach(l => {
        const w1 = getEffectiveWeightFor1RM(l);
        const wVol = getEffectiveWeightForVolume(l);
        const r = Number(l.reps) || 0;

        const est = estimate1RM(w1, r);
        const vol = wVol * r;

        if (est > best1RM) best1RM = est;
        if (vol > bestVolume) bestVolume = vol;
        if (r === 5 && w1 > best5RMWeight) best5RMWeight = w1;
        if (r === 10 && w1 > best10RMWeight) best10RMWeight = w1;
      });

      return { best1RM, bestVolume, best5RMWeight, best10RMWeight };
    }

    // G√©n√®re les messages de PR en comparant "avant" vs "apr√®s" la nouvelle s√©rie
    function buildPRMessages(oldStats, newStats) {
      const messages = [];

      if (oldStats.best1RM === 0 && newStats.best1RM > 0) {
        messages.push(`1√®re r√©f√©rence 1RM : ${newStats.best1RM.toFixed(1)} kg`);
      } else if (newStats.best1RM > oldStats.best1RM && oldStats.best1RM > 0) {
        messages.push(`Nouveau PR 1RM estim√©e : ${newStats.best1RM.toFixed(1)} kg`);
      }

      if (oldStats.bestVolume === 0 && newStats.bestVolume > 0) {
        messages.push(`1√®re s√©rie de r√©f√©rence (volume) : ${(newStats.bestVolume).toFixed(0)} kg¬∑reps`);
      } else if (newStats.bestVolume > oldStats.bestVolume && oldStats.bestVolume > 0) {
        messages.push(`Nouveau PR de volume sur une s√©rie : ${(newStats.bestVolume).toFixed(0)} kg¬∑reps`);
      }

      if (newStats.best5RMWeight > oldStats.best5RMWeight && newStats.best5RMWeight > 0) {
        messages.push(`Nouveau PR sur 5 reps : ${newStats.best5RMWeight.toFixed(1)} kg`);
      }

      if (newStats.best10RMWeight > oldStats.best10RMWeight && newStats.best10RMWeight > 0) {
        messages.push(`Nouveau PR sur 10 reps : ${newStats.best10RMWeight.toFixed(1)} kg`);
      }

      return messages;
    }

    // Suggestion simple pour la prochaine charge √† partir de la s√©rie saisie
    function getNextLoadSuggestion(weight, reps, rpe) {
      const w = Number(weight) || 0;
      const r = Number(reps) || 0;
      const rpeNum = rpe ? Number(rpe) : null;

      let base = `Derni√®re s√©rie : ${w}kg √ó ${r} reps${rpeNum ? ` (RPE ${rpeNum})` : ""}. `;
      let advice = "";

      if (rpeNum === null) {
        if (r >= 10) {
          advice = "Tu peux tenter +2.5 kg √† la m√™me plage de reps, ou garder le poids et viser 1‚Äì2 reps de plus.";
        } else if (r >= 6) {
          advice = "Reste sur ce poids et cherche 1 rep de plus √† la prochaine s√©ance.";
        } else {
          advice = "Tu es tr√®s loin de l'√©chec, tu peux monter la charge ou les reps sans risque.";
        }
      } else if (rpeNum <= 7) {
        advice = "Large marge : +2.5‚Äì5 kg ou +2 reps √† la prochaine s√©ance.";
      } else if (rpeNum <= 8.5) {
        advice = "Zone de travail parfaite : +1 rep ou +2.5 kg si tu te sens bien.";
      } else {
        advice = "Proche de l'√©chec : garde le m√™me poids et stabilise avant de remonter.";
      }

      return base + advice;
    }

    // THEMES dynamiques en fonction de l'utilisateur + s√©ance
      function updateTheme() {
        // Palette fixe, plus de th√®mes dynamiques
      }

        // ========== ADD/DELETE ==========
        window.addSet = function(exerciseId) {
        const weightInput = document.getElementById(`weight-${exerciseId}`);
        const repsInput = document.getElementById(`reps-${exerciseId}`);
        const rpeInput = document.getElementById(`rpe-${exerciseId}`);
        const modeSelect = document.getElementById(`mode-${exerciseId}`);
        
        const weight = weightInput.value;
        const reps = repsInput.value;
        const rpe = rpeInput.value;
        const mode = modeSelect ? modeSelect.value : "total";

        if (!weight && mode !== "virtual" && mode !== "bodyweight") {
          alert("‚ö†Ô∏è Veuillez remplir le poids (ou choisir un mode virtuel / poids de corps).");
          return;
        }
        if (!reps) {
          alert("‚ö†Ô∏è Veuillez remplir les r√©p√©titions.");
          return;
        }

        const oldStats = computeExercisePRStats(state.user, exerciseId);

        state.logs.push({
          user: state.user,
          date: state.date,
          exerciseId: exerciseId,
          weight: Number(weight) || 0,
          reps: Number(reps),
          rpe: rpe ? Number(rpe) : null,
          mode: mode
        });

          saveState();
          weightInput.value = "";
          repsInput.value = "";
          rpeInput.value = "";

          // On re-render l'onglet entra√Ænement
          renderEntrainement();

          // PR "apr√®s" la nouvelle s√©rie
          const newStats = computeExercisePRStats(state.user, exerciseId);
          const prMessages = buildPRMessages(oldStats, newStats);

          const prEl = document.getElementById(`pr-${exerciseId}`);
          if (prEl) {
            if (prMessages.length > 0) {
              prEl.innerHTML = prMessages
                .map(msg => `<span class="pr-badge">üî• ${msg}</span>`)
                .join(" ");
            } else {
              prEl.innerHTML = "";
            }
          }

          // Suggestion de charge pour la prochaine s√©ance
          const suggestionText = getNextLoadSuggestion(weight, reps, rpe);
          const suggEl = document.getElementById(`suggestion-${exerciseId}`);
          if (suggEl) {
            suggEl.textContent = suggestionText;
          }
        };

        window.deleteLog = function(index) {
          if (confirm("Supprimer cette s√©rie ?")) {
            state.logs.splice(index, 1);
            saveState();
            renderEntrainement();
          }
        };

    // ========== INIT ==========
    loadState();
    loadPlayerProfile();
    userSelect.value = state.user;
    dateInput.value = state.date;
    fatigueSelect.value = state.fatigue || "normal";
    renderHome();
    renderEntrainement();
    setupProfileInputs();

    // ========== PWA: Service Worker ==========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => {
            console.log('Service Worker registered:', reg.scope);
          })
          .catch(err => {
            console.error('Service Worker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>